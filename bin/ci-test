#!/bin/bash
# CI/CD 테스트 스크립트
# 사용법: bin/ci-test 또는 bin/ci-test --quick
set -e

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "=========================================="
echo "  CI/CD 테스트 시작"
echo "=========================================="
echo ""

# Quick 모드 체크
QUICK_MODE=false
if [ "$1" == "--quick" ]; then
  QUICK_MODE=true
  echo -e "${YELLOW}Quick 모드: 빠른 검증만 수행합니다${NC}"
  echo ""
fi

# 1. Unit/Integration Tests
echo -e "${YELLOW}[1/4] Unit/Integration Tests 실행 중...${NC}"
if [ "$QUICK_MODE" = true ]; then
  # Quick 모드: 빠른 테스트만
  SKIP_ASSET_BUILD=true bin/rails test test/models test/controllers --verbose 2>&1 | tail -20
else
  # Full 모드: 전체 테스트
  SKIP_ASSET_BUILD=true bin/rails test
fi

if [ $? -eq 0 ]; then
  echo -e "${GREEN}✓ Unit/Integration Tests 통과${NC}"
else
  echo -e "${RED}✗ Unit/Integration Tests 실패${NC}"
  exit 1
fi
echo ""

# 2. Rubocop
echo -e "${YELLOW}[2/4] Rubocop 실행 중...${NC}"
if [ "$QUICK_MODE" = true ]; then
  # Quick 모드: 새로 변경된 파일만
  CHANGED_FILES=$(git diff --name-only --diff-filter=ACM HEAD | grep '\.rb$' || true)
  if [ -n "$CHANGED_FILES" ]; then
    echo "$CHANGED_FILES" | xargs bundle exec rubocop --force-exclusion
  else
    echo "변경된 Ruby 파일 없음, 건너뜀"
  fi
else
  bundle exec rubocop --parallel
fi

if [ $? -eq 0 ]; then
  echo -e "${GREEN}✓ Rubocop 통과${NC}"
else
  echo -e "${RED}✗ Rubocop 위반 발견${NC}"
  exit 1
fi
echo ""

# 3. Brakeman Security Scan
echo -e "${YELLOW}[3/4] Brakeman Security Scan 실행 중...${NC}"
bundle exec brakeman -q --no-pager -w2

if [ $? -eq 0 ]; then
  echo -e "${GREEN}✓ Brakeman 통과 (보안 취약점 없음)${NC}"
else
  echo -e "${RED}✗ Brakeman 보안 경고 발견${NC}"
  exit 1
fi
echo ""

# 4. JavaScript Syntax Check (선택적)
echo -e "${YELLOW}[4/4] JavaScript 구문 검사 중...${NC}"
if command -v npx &> /dev/null; then
  # ESLint가 설치되어 있으면 실행
  if [ -f "node_modules/.bin/eslint" ]; then
    npx eslint app/javascript/controllers/*.js --no-error-on-unmatched-pattern 2>/dev/null || true
  else
    echo "ESLint 미설치, 건너뜀"
  fi
else
  echo "npx 미설치, JavaScript 검사 건너뜀"
fi
echo -e "${GREEN}✓ JavaScript 검사 완료${NC}"
echo ""

# 완료
echo "=========================================="
echo -e "${GREEN}  모든 CI 테스트 통과!${NC}"
echo "=========================================="
echo ""
echo "다음 단계:"
echo "  - E2E 테스트: npx playwright test --project=chromium"
echo "  - 커밋: git add . && git commit -m '[test] CI 테스트 통과'"
echo ""
