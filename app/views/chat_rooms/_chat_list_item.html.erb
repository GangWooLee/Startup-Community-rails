<%# 채팅 목록 아이템 (좌측 패널용) %>
<%# locals: room, current_user, is_active (optional) %>
<%
  other_user = room.other_participant(current_user)
  is_active = local_assigns.fetch(:is_active, false)
  unread = room.unread_count_for(current_user)
  last_msg = room.messages.order(created_at: :desc).first
%>

<div id="chat_room_<%= room.id %>"
     class="chat-room-item"
     data-chat-list-target="room"
     data-last-message-at="<%= room.last_message_at&.to_i || 0 %>">
  <%= link_to chat_room_path(room),
              class: "flex items-center gap-3 px-4 py-3 #{is_active ? 'bg-primary/10' : (unread > 0 ? 'bg-primary/5' : 'card-hover')}",
              data: {
                turbo_frame: "chat_room_content",
                chat_list_target: "item",
                chat_list_room_id: room.id,
                action: "click->chat-list#select"
              } do %>
    <!-- 프로필 이미지 -->
    <div class="relative flex-shrink-0">
      <% if other_user&.avatar&.attached? %>
        <%= image_tag other_user.avatar, class: "w-12 h-12 rounded-full object-cover border border-border" %>
      <% else %>
        <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-lg <%= avatar_bg_color(other_user&.name) %>">
          <%= other_user&.name&.first&.upcase || "?" %>
        </div>
      <% end %>
    </div>

    <!-- 대화 정보 -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center justify-between gap-2">
        <p class="<%= unread > 0 ? 'font-bold' : 'font-semibold' %> text-foreground truncate text-sm"><%= other_user&.name || "알 수 없음" %></p>
        <% if room.last_message_at.present? %>
          <span class="text-xs text-muted-foreground whitespace-nowrap"
                data-controller="relative-time"
                data-relative-time-timestamp-value="<%= room.last_message_at.iso8601 %>"></span>
        <% end %>
      </div>
      <% if other_user&.role_title.present? %>
        <p class="text-xs text-muted-foreground truncate"><%= other_user.role_title %></p>
      <% end %>
      <% if room.source_post.present? %>
        <p class="text-xs text-muted-foreground/70 truncate mt-0.5 flex items-center gap-1">
          <% if room.source_post.hiring? %>
            <%# 구인 - 사람 찾기 아이콘 (주황색) %>
            <svg class="w-3.5 h-3.5 text-orange-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
            </svg>
          <% elsif room.source_post.seeking? %>
            <%# 구직 - 일자리 찾기 아이콘 (파란색) %>
            <svg class="w-3.5 h-3.5 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/>
              <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>
            </svg>
          <% else %>
            <%# 일반 커뮤니티 글 아이콘 %>
            <svg class="w-3.5 h-3.5 text-muted-foreground flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
            </svg>
          <% end %>
          <span class="truncate"><%= truncate(room.source_post.title, length: 18) %></span>
        </p>
      <% end %>
      <% if last_msg %>
        <p class="text-xs <%= unread > 0 ? 'text-foreground font-medium' : 'text-muted-foreground' %> truncate mt-0.5">
          <% if last_msg.sender_id == current_user.id %>
            <span class="text-muted-foreground/70">나: </span>
          <% end %>
          <%= message_preview(last_msg) %>
        </p>
      <% end %>
    </div>

    <!-- 안읽음 뱃지 -->
    <% if unread > 0 %>
      <span class="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full min-w-[20px] text-center font-medium flex-shrink-0">
        <%= unread > 99 ? "99+" : unread %>
      </span>
    <% end %>
  <% end %>
</div>
