<%# 채팅 목록 아이템 (좌측 패널용) - Fluid Lounge Style %>
<%# locals: room, current_user, is_active (optional) %>
<%
  other_user = room.other_participant(current_user)
  is_active = local_assigns.fetch(:is_active, false)
  unread = room.unread_count_for(current_user)
  last_msg = room.messages.order(created_at: :desc).first
  is_deleted_user = other_user.nil?
%>

<div id="chat_room_<%= room.id %>"
     class="chat-room-item"
     data-chat-list-target="room"
     data-last-message-at="<%= room.last_message_at&.to_i || 0 %>">

  <%= link_to chat_room_path(room),
                class: "flex items-center gap-3 px-5 py-4 transition-all
                        #{is_active ? 'bg-orange-50/50 border-l-4 border-orange-500' : 'border-l-4 border-transparent hover:bg-stone-50'}
                        #{unread > 0 && !is_active ? 'bg-orange-50/30' : ''}",
                data: {
                  turbo_frame: "chat_room_content",
                  chat_list_target: "item",
                  chat_list_room_id: room.id,
                  action: "click->chat-list#select"
                } do %>
      <!-- 프로필 이미지 -->
      <div class="relative flex-shrink-0">
        <% if is_deleted_user %>
          <%# 탈퇴한 회원 - Ghost Icon %>
          <div class="w-12 h-12 rounded-full bg-stone-200 flex items-center justify-center ring-2 ring-stone-100">
            <svg class="w-6 h-6 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
        <% else %>
          <%# 정상 사용자 - 익명 모드 지원 %>
          <div class="w-12 h-12 rounded-full ring-2 ring-stone-100 overflow-hidden flex items-center justify-center bg-secondary">
            <% if other_user.using_anonymous_avatar? %>
              <%= image_tag "/anonymous#{other_user.avatar_type.to_i + 1}-.png", alt: other_user.display_name, class: "w-full h-full object-cover" %>
            <% elsif other_user.avatar.attached? %>
              <%= image_tag other_user.avatar, alt: other_user.display_name, class: "w-full h-full object-cover" %>
            <% elsif other_user.avatar_url.present? %>
              <%= image_tag other_user.avatar_url, alt: other_user.display_name, class: "w-full h-full object-cover" %>
            <% else %>
              <span class="text-xl font-semibold text-muted-foreground"><%= other_user.display_name[0] %></span>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- 대화 정보 -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between gap-2">
          <% if is_deleted_user %>
            <p class="font-medium text-stone-400 truncate text-sm">Unknown Maker</p>
          <% else %>
            <p class="<%= unread > 0 ? 'font-bold text-stone-900' : 'font-semibold text-stone-700' %> truncate text-sm"><%= other_user.display_name %></p>
          <% end %>
          <% if room.last_message_at.present? %>
            <span class="text-xs text-stone-400 whitespace-nowrap"
                  data-controller="relative-time"
                  data-relative-time-timestamp-value="<%= room.last_message_at.iso8601 %>"></span>
          <% end %>
        </div>
        <% if other_user&.role_title.present? %>
          <p class="text-xs text-stone-500 truncate"><%= other_user.role_title %></p>
        <% end %>
        <% if room.source_post.present? %>
          <p class="text-xs text-stone-400 truncate mt-0.5 flex items-center gap-1">
            <% if room.source_post.hiring? %>
              <%# 구인 - 사람 찾기 아이콘 (주황색) %>
              <svg class="w-3.5 h-3.5 text-orange-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
              </svg>
            <% elsif room.source_post.seeking? %>
              <%# 구직 - 일자리 찾기 아이콘 (파란색) %>
              <svg class="w-3.5 h-3.5 text-blue-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"/>
                <path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"/>
              </svg>
            <% else %>
              <%# 일반 커뮤니티 글 아이콘 %>
              <svg class="w-3.5 h-3.5 text-stone-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
              </svg>
            <% end %>
            <span class="truncate"><%= truncate(room.source_post.title, length: 18) %></span>
          </p>
        <% end %>
        <% if last_msg %>
          <p class="text-xs <%= unread > 0 ? 'text-stone-700 font-medium' : 'text-stone-500' %> truncate mt-0.5">
            <% if last_msg.sender_id == current_user.id %>
              <span class="text-stone-400">나: </span>
            <% end %>
            <%= message_preview(last_msg) %>
          </p>
        <% end %>
      </div>

      <!-- 안읽음 뱃지 - Orange for Brand Consistency -->
      <% if unread > 0 %>
        <span class="bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full min-w-[22px] text-center font-semibold flex-shrink-0 shadow-sm">
          <%= unread > 99 ? "99+" : unread %>
        </span>
      <% end %>
    <% end %>
</div>
