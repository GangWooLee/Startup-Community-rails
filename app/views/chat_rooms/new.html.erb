<% content_for :turbo_frame_chat_room_content do %>
  <%= turbo_frame_tag "chat_room_content", class: "hidden md:flex flex-1 flex-col bg-gray-50" do %>
    <%= render "chat_rooms/new_message_panel", preselected_recipient: @preselected_recipient %>
  <% end %>
<% end %>

<% if turbo_frame_request? %>
  <%# PC에서 새 메시지 버튼 클릭 시 - Turbo Frame으로 우측만 업데이트 %>
  <%= content_for :turbo_frame_chat_room_content %>
<% else %>
  <%# 모바일에서 접근 또는 직접 URL 접근 시 - 전체 페이지 렌더링 %>
  <!-- PC: 2단 분할 레이아웃, 모바일: 전체 화면 -->
  <div class="flex flex-col md:flex-row h-[calc(100vh-64px)] bg-background">

    <!-- 좌측: 채팅 목록 패널 (PC에서만 표시) -->
    <div class="hidden md:block">
      <%
        filter = params[:filter] || "all"
        search = params[:search]

        # 삭제되지 않은 채팅방만 조회 (prepare_chat_list_data와 동일하게)
        base_query = current_user.active_chat_rooms
                                 .includes(:users, :source_post, :participants, messages: :sender)

        chat_rooms = case filter
        when "received"
          base_query.received_inquiries(current_user)
        when "sent"
          base_query.sent_inquiries(current_user)
        else
          base_query
        end

        if search.present?
          chat_rooms = chat_rooms.search_by_keyword(search, current_user)
        end

        chat_rooms = chat_rooms.order(last_message_at: :desc)

        # 읽지 않은 메시지 수도 삭제되지 않은 채팅방만 계산
        all_rooms = current_user.active_chat_rooms.includes(:participants, :source_post, messages: :sender)
        total_unread = all_rooms.sum { |room| room.unread_count_for(current_user) }
        received_unread = all_rooms.select { |room| room.source_post&.user_id == current_user.id && room.initiator_id != current_user.id }.sum { |room| room.unread_count_for(current_user) }
        sent_unread = all_rooms.select { |room| room.initiator_id == current_user.id }.sum { |room| room.unread_count_for(current_user) }
      %>
      <%= render "chat_rooms/chat_list_panel",
                 filter: filter,
                 search: search,
                 total_unread: total_unread,
                 received_unread: received_unread,
                 sent_unread: sent_unread,
                 chat_rooms: chat_rooms %>
    </div>

    <!-- 우측/전체: 새 메시지 작성 패널 -->
    <%= turbo_frame_tag "chat_room_content", class: "flex-1 flex flex-col h-full" do %>
      <%= render "chat_rooms/new_message_panel", preselected_recipient: @preselected_recipient %>
    <% end %>
  </div>

  <!-- 하단 네비게이션 바 (모바일에서만 표시) -->
  <%= render "shared/bottom_nav" %>
<% end %>
