<% content_for :turbo_frame_chat_room_content do %>
  <%= turbo_frame_tag "chat_room_content", class: "hidden md:flex flex-1 flex-col bg-secondary/30" do %>
    <%= render "chat_rooms/new_message_panel", preselected_recipient: @preselected_recipient %>
  <% end %>
<% end %>

<% if turbo_frame_request? %>
  <%# PC에서 새 메시지 버튼 클릭 시 - Turbo Frame으로 우측만 업데이트 %>
  <%= content_for :turbo_frame_chat_room_content %>
<% else %>
  <%# 모바일에서 접근 또는 직접 URL 접근 시 - 전체 페이지 렌더링 %>
  <!-- PC: 2단 분할 레이아웃, 모바일: 전체 화면 -->
  <div class="flex flex-col md:flex-row h-[calc(100vh-64px)] bg-background">

    <!-- 좌측: 채팅 목록 패널 (PC에서만 표시) -->
    <div class="hidden md:block">
      <%
        filter = params[:filter] || "all"
        search = params[:search]

        # 삭제되지 않은 채팅방만 조회 (prepare_chat_list_data와 동일하게)
        # 성능 최적화: messages: :sender 대신 last_message_preview 사용
        base_query = current_user.active_chat_rooms
                                 .includes(:users, :source_post, :participants, last_message_preview: :sender)

        chat_rooms = case filter
        when "received"
          base_query.received_inquiries(current_user)
        when "sent"
          base_query.sent_inquiries(current_user)
        else
          base_query
        end

        if search.present?
          chat_rooms = chat_rooms.search_by_keyword(search, current_user)
        end

        chat_rooms = chat_rooms.order(last_message_at: :desc)

        # 읽지 않은 메시지 수 계산 - SQL 집계로 N+1 쿼리 방지
        active_participants = current_user.chat_room_participants.active

        # 전체 미읽음: 모든 활성 채팅방의 unread_count 합계
        total_unread = active_participants.sum(:unread_count)

        # 받은 문의 미읽음: source_post 작성자가 본인이고, 본인이 시작하지 않은 채팅
        received_unread = active_participants
          .joins(chat_room: :source_post)
          .where(posts: { user_id: current_user.id })
          .where.not(chat_rooms: { initiator_id: current_user.id })
          .sum(:unread_count)

        # 보낸 문의 미읽음: 본인이 시작한 채팅
        sent_unread = active_participants
          .joins(:chat_room)
          .where(chat_rooms: { initiator_id: current_user.id })
          .sum(:unread_count)
      %>
      <%= render "chat_rooms/chat_list_panel",
                 filter: filter,
                 search: search,
                 total_unread: total_unread,
                 received_unread: received_unread,
                 sent_unread: sent_unread,
                 chat_rooms: chat_rooms %>
    </div>

    <!-- 우측/전체: 새 메시지 작성 패널 -->
    <%= turbo_frame_tag "chat_room_content", class: "flex-1 flex flex-col h-full" do %>
      <%= render "chat_rooms/new_message_panel", preselected_recipient: @preselected_recipient %>
    <% end %>
  </div>
<% end %>
