<% content_for :turbo_frame_chat_room_content do %>
  <%= turbo_frame_tag "chat_room_content", class: "hidden md:flex flex-1 flex-col bg-white" do %>
    <%= render "chat_rooms/chat_room_detail",
               chat_room: @chat_room,
               messages: @messages,
               other_user: @other_user %>
  <% end %>
<% end %>

<% if turbo_frame_request? %>
  <%# PC에서 좌측 패널 채팅방 클릭 시 - Turbo Frame으로 우측만 업데이트 %>
  <%= content_for :turbo_frame_chat_room_content %>
<% else %>
  <%# 모바일에서 접근 또는 직접 URL 접근 시 - 전체 페이지 렌더링 %>
  <%# The Fluid Lounge - Island Container Layout %>
  <div class="h-full bg-[#FDFBF7] md:flex md:items-center md:justify-center md:p-6">
    <%# Island Container - 떠 있는 둥근 카드 (반응형 확장) %>
    <div class="w-full md:max-w-5xl lg:max-w-6xl xl:max-w-[1600px] 2xl:max-w-[1800px]
                h-screen md:h-[calc(100vh-100px)] xl:h-[calc(100vh-80px)] 2xl:h-[calc(100vh-60px)]
                bg-white md:rounded-[2rem] md:shadow-2xl md:shadow-stone-900/5
                md:border md:border-stone-100 overflow-hidden
                flex flex-col md:flex-row">

    <!-- 좌측: 채팅 목록 패널 (PC에서만 표시, 유동적 너비) -->
    <div class="hidden md:block md:w-[clamp(280px,28vw,360px)] xl:w-[clamp(300px,22vw,340px)] flex-shrink-0">
      <%
        # show 페이지에서도 index와 동일한 데이터 구조 사용
        filter = params[:filter] || "all"
        search = params[:search]

        # 삭제되지 않은 채팅방만 조회 (prepare_chat_list_data와 동일하게)
        # 성능 최적화: messages: :sender 대신 last_message_preview 사용
        base_query = current_user.active_chat_rooms
                                 .includes(:users, :source_post, :participants, last_message_preview: :sender)

        chat_rooms = case filter
        when "received"
          base_query.received_inquiries(current_user)
        when "sent"
          base_query.sent_inquiries(current_user)
        else
          base_query
        end

        if search.present?
          chat_rooms = chat_rooms.search_by_keyword(search, current_user)
        end

        chat_rooms = chat_rooms.order(last_message_at: :desc)

        # 읽지 않은 메시지 수 계산 - SQL 집계로 N+1 쿼리 방지
        active_participants = current_user.chat_room_participants.active

        # 전체 미읽음: 모든 활성 채팅방의 unread_count 합계
        total_unread = active_participants.sum(:unread_count)

        # 받은 문의 미읽음: source_post 작성자가 본인이고, 본인이 시작하지 않은 채팅
        received_unread = active_participants
          .joins(chat_room: :source_post)
          .where(posts: { user_id: current_user.id })
          .where.not(chat_rooms: { initiator_id: current_user.id })
          .sum(:unread_count)

        # 보낸 문의 미읽음: 본인이 시작한 채팅
        sent_unread = active_participants
          .joins(:chat_room)
          .where(chat_rooms: { initiator_id: current_user.id })
          .sum(:unread_count)
      %>
      <%= render "chat_rooms/chat_list_panel",
                 filter: filter,
                 search: search,
                 total_unread: total_unread,
                 received_unread: received_unread,
                 sent_unread: sent_unread,
                 chat_rooms: chat_rooms,
                 current_chat_room: @chat_room %>
    </div>

    <!-- 중앙: 채팅방 상세 -->
    <%= turbo_frame_tag "chat_room_content", class: "flex-1 flex flex-col h-full bg-white" do %>
      <%= render "chat_rooms/chat_room_detail",
                 chat_room: @chat_room,
                 messages: @messages,
                 other_user: @other_user %>
    <% end %>

    <!-- 우측: 정보 패널 (xl에서부터 표시 - 유동적 너비) -->
    <aside class="hidden xl:flex xl:flex-col xl:w-[clamp(260px,18vw,320px)] flex-shrink-0 border-l border-stone-200/60"
           aria-label="상대방 정보">
      <%= render "chat_rooms/info_panel",
                 other_user: @other_user,
                 chat_room: @chat_room %>
    </aside>

    </div><%# Island Container 닫기 %>
  </div><%# Outer wrapper 닫기 %>
<% end %>
