<%# 결제 실패 페이지 %>
<%
  # 에러 코드별 안내 메시지 매핑
  error_guides = {
    # 카드 관련 에러
    "INVALID_CARD_NUMBER" => { title: "카드 번호 오류", guide: "카드 번호를 다시 확인해주세요.", icon: "credit-card", retry: true },
    "INVALID_CARD_EXPIRY" => { title: "카드 유효기간 오류", guide: "카드 유효기간을 다시 확인해주세요.", icon: "calendar", retry: true },
    "INVALID_CVV" => { title: "CVV 오류", guide: "카드 뒷면의 CVV 번호를 다시 확인해주세요.", icon: "lock", retry: true },
    "CARD_DECLINED" => { title: "카드 거절", guide: "카드사에서 결제를 거절했습니다. 카드사에 문의하시거나 다른 카드로 시도해주세요.", icon: "x-circle", retry: true },
    "EXCEED_CARD_LIMIT" => { title: "한도 초과", guide: "카드 결제 한도를 초과했습니다. 카드사에 한도를 확인하시거나 다른 카드를 사용해주세요.", icon: "trending-up", retry: true },
    "INVALID_INSTALLMENT_PLAN" => { title: "할부 오류", guide: "선택한 할부 개월 수를 이용할 수 없습니다. 다른 할부 옵션을 선택해주세요.", icon: "calendar", retry: true },
    "NOT_SUPPORTED_CARD" => { title: "미지원 카드", guide: "현재 지원하지 않는 카드입니다. 다른 카드로 시도해주세요.", icon: "credit-card", retry: true },

    # 금액 관련 에러
    "AMOUNT_MISMATCH" => { title: "금액 불일치", guide: "결제 금액이 일치하지 않습니다. 처음부터 다시 시도해주세요.", icon: "alert-triangle", retry: true },
    "BELOW_MINIMUM_AMOUNT" => { title: "최소 금액 미만", guide: "최소 결제 금액 이상이어야 합니다.", icon: "minus-circle", retry: false },
    "EXCEED_MAXIMUM_AMOUNT" => { title: "최대 금액 초과", guide: "최대 결제 금액을 초과했습니다.", icon: "plus-circle", retry: false },

    # 사용자 취소
    "PAY_PROCESS_CANCELED" => { title: "결제 취소", guide: "결제가 취소되었습니다. 다시 시도하시려면 아래 버튼을 클릭해주세요.", icon: "x", retry: true },
    "USER_CANCEL" => { title: "사용자 취소", guide: "결제를 취소하셨습니다. 다시 시도하시려면 아래 버튼을 클릭해주세요.", icon: "x", retry: true },

    # 시스템 에러
    "PROVIDER_ERROR" => { title: "결제사 오류", guide: "결제 처리 중 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.", icon: "server", retry: true },
    "NETWORK_ERROR" => { title: "네트워크 오류", guide: "네트워크 연결이 불안정합니다. 인터넷 연결을 확인하고 다시 시도해주세요.", icon: "wifi-off", retry: true },
    "TIMEOUT" => { title: "시간 초과", guide: "결제 처리 시간이 초과되었습니다. 잠시 후 다시 시도해주세요.", icon: "clock", retry: true },

    # 인증 에러
    "INVALID_PASSWORD" => { title: "비밀번호 오류", guide: "카드 비밀번호가 올바르지 않습니다. 다시 확인해주세요.", icon: "key", retry: true },
    "AUTHENTICATION_FAILED" => { title: "본인인증 실패", guide: "본인인증에 실패했습니다. 다시 시도해주세요.", icon: "user-x", retry: true },

    # 기타
    "ALREADY_PROCESSED" => { title: "이미 처리됨", guide: "이 결제는 이미 처리되었습니다.", icon: "check-circle", retry: false },
    "INVALID_REQUEST" => { title: "잘못된 요청", guide: "요청이 올바르지 않습니다. 처음부터 다시 시도해주세요.", icon: "alert-circle", retry: true }
  }

  error_info = error_guides[@error_code] || {
    title: "결제 오류",
    guide: "결제 처리 중 문제가 발생했습니다. 잠시 후 다시 시도해주세요.",
    icon: "alert-triangle",
    retry: true
  }
%>

<div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4">
  <div class="max-w-md w-full">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 text-center">
      <%# 실패 아이콘 %>
      <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-6">
        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </div>

      <h1 class="text-2xl font-bold text-gray-900 mb-2"><%= error_info[:title] %></h1>
      <p class="text-gray-600 mb-6"><%= error_info[:guide] %></p>

      <%# 에러 상세 정보 (접기/펼치기) %>
      <details class="text-left mb-6">
        <summary class="cursor-pointer text-sm text-gray-500 hover:text-gray-700 flex items-center justify-center space-x-1">
          <span>상세 정보 보기</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </summary>
        <div class="mt-4 bg-gray-50 rounded-xl p-4">
          <dl class="space-y-2 text-sm">
            <% if @error_code.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500">오류 코드</dt>
                <dd class="font-mono text-gray-900"><%= @error_code %></dd>
              </div>
            <% end %>
            <% if @error_message.present? %>
              <div>
                <dt class="text-gray-500 mb-1">오류 메시지</dt>
                <dd class="text-gray-900 break-words"><%= @error_message %></dd>
              </div>
            <% end %>
            <% if @order_id.present? %>
              <div class="flex justify-between">
                <dt class="text-gray-500">주문 번호</dt>
                <dd class="font-mono text-xs text-gray-900"><%= @order_id %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      </details>

      <%# 해결 방법 안내 카드 %>
      <% if error_info[:retry] %>
        <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-left">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-blue-900">해결 방법</p>
              <ul class="mt-2 text-sm text-blue-800 space-y-1">
                <li>• 카드 정보를 다시 확인해주세요</li>
                <li>• 다른 결제 수단을 시도해보세요</li>
                <li>• 브라우저를 새로고침 후 다시 시도해주세요</li>
              </ul>
            </div>
          </div>
        </div>
      <% end %>

      <%# 버튼 %>
      <div class="space-y-3">
        <% if error_info[:retry] && @order_id.present? %>
          <% payment = Payment.find_by(toss_order_id: @order_id) %>
          <% if payment&.order&.post %>
            <%= link_to new_payment_path(post_id: payment.order.post_id),
                        class: "flex items-center justify-center space-x-2 w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-colors" do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              <span>다시 시도하기</span>
            <% end %>
          <% end %>
        <% end %>

        <%= link_to job_posts_path,
                    class: "flex items-center justify-center space-x-2 w-full py-3 px-6 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          <span>목록으로 돌아가기</span>
        <% end %>
      </div>

      <%# 고객센터 안내 %>
      <div class="mt-6 pt-6 border-t border-gray-100">
        <p class="text-sm text-gray-600 mb-3">문제가 계속되면 고객센터로 문의해주세요.</p>
        <a href="mailto:support@startup-community.com"
           class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-700 text-sm font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span>support@startup-community.com</span>
        </a>
      </div>
    </div>
  </div>
</div>
