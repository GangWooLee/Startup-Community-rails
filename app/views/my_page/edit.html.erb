<div class="min-h-screen bg-background pb-20">
  <!-- Header -->
  <header class="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-40">
    <div class="max-w-screen-xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- 뒤로가기 버튼 -->
          <%= render_button variant: :ghost, class: "h-9 w-9 p-0", data: { controller: "navigation", navigation_fallback_value: my_page_path, action: "click->navigation#goBack" } do %>
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          <% end %>

          <!-- 타이틀 -->
          <div>
            <h1 class="text-xl font-bold">프로필 수정</h1>
            <p class="text-xs text-muted-foreground">프로필 정보를 수정하세요</p>
          </div>
        </div>

        <!-- 저장 버튼 (우측) -->
        <%= render_button type: :submit, form: "profile-edit-form", size: :sm, class: "px-4" do %>
          저장
        <% end %>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-screen-xl mx-auto px-4 py-6">
    <%= form_with model: @user, url: my_page_path, method: :patch, local: true, id: "profile-edit-form", class: "space-y-6" do |f| %>
      <%# Error Messages - render_alert 헬퍼 사용 %>
      <% if @user.errors.any? %>
        <%= render_alert variant: :error, title: "오류가 발생했습니다:" do %>
          <ul class="list-disc list-inside text-sm space-y-1">
            <% @user.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        <% end %>
      <% end %>

      <!-- Profile Image - 이미지 미리보기 기능 -->
      <div class="rounded-xl border bg-card text-card-foreground p-6"
           data-controller="image-preview"
           data-image-preview-max-size-value="2097152">
        <h3 class="text-lg font-semibold mb-4">프로필 사진</h3>
        <div class="flex items-center gap-6">
          <%# 프로필 이미지 미리보기 영역 %>
          <div class="h-24 w-24 rounded-full overflow-hidden flex-shrink-0 bg-secondary flex items-center justify-center">
            <% if @user.avatar.attached? %>
              <%= image_tag @user.avatar, alt: @user.display_name,
                            class: "h-full w-full object-cover",
                            data: { image_preview_target: "preview" } %>
            <% elsif @user.avatar_url.present? %>
              <%= image_tag @user.avatar_url, alt: @user.display_name,
                            class: "h-full w-full object-cover",
                            data: { image_preview_target: "preview" } %>
            <% else %>
              <%# 기존 아바타가 없을 때 placeholder + 미리보기 이미지 %>
              <span class="text-3xl font-semibold text-muted-foreground"
                    data-image-preview-target="placeholder"><%= @user.display_name[0] %></span>
              <img src="" alt="미리보기" class="h-full w-full object-cover hidden"
                   data-image-preview-target="preview">
            <% end %>
          </div>
          <div class="flex-1">
            <label class="block mb-2">
              <span class="text-sm font-medium text-foreground">새 프로필 사진 업로드</span>
              <%= f.file_field :avatar,
                  accept: "image/*",
                  data: { image_preview_target: "input", action: "change->image-preview#preview" },
                  class: "mt-2 block w-full text-sm text-muted-foreground
                         file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                         file:text-sm file:font-medium file:bg-primary file:text-primary-foreground
                         hover:file:bg-primary/90 file:cursor-pointer cursor-pointer" %>
            </label>
            <p class="text-xs text-muted-foreground">JPG, PNG, GIF (최대 2MB)</p>
          </div>
        </div>
      </div>

      <!-- 익명 설정 -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4"
           data-controller="anonymous-settings">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold">익명 설정</h3>
            <p class="text-sm text-muted-foreground">커뮤니티에서 익명으로 활동할 수 있습니다</p>
          </div>
          <%# 현재 표시 이름 미리보기 %>
          <div class="text-right">
            <p class="text-xs text-muted-foreground">현재 표시 이름</p>
            <p class="font-semibold text-foreground" data-anonymous-settings-target="preview">
              <%= @user.display_name %>
            </p>
          </div>
        </div>

        <%# 익명 모드 토글 %>
        <div class="flex items-center gap-3 p-4 rounded-lg border border-border bg-secondary/30">
          <label class="flex items-center gap-3 cursor-pointer flex-1">
            <%= f.check_box :is_anonymous,
                            checked: @user.is_anonymous?,
                            data: { anonymous_settings_target: "toggle", action: "change->anonymous-settings#toggleMode" },
                            class: "h-5 w-5 rounded text-primary focus:ring-primary border-border cursor-pointer" %>
            <div>
              <span class="font-medium text-foreground">익명 모드 활성화</span>
              <p class="text-xs text-muted-foreground">
                활성화하면 닉네임과 익명 아바타로 활동합니다
              </p>
            </div>
          </label>
        </div>

        <%# 닉네임 입력 (익명 모드일 때만 표시) %>
        <div data-anonymous-settings-target="nicknameSection"
             class="<%= @user.is_anonymous? ? '' : 'hidden' %> space-y-4 pt-4 border-t border-border">

          <%# 닉네임 %>
          <div class="space-y-2">
            <%= render_label name: "user[nickname]", label: "닉네임" %>
            <div class="relative">
              <%= render_input name: "user[nickname]",
                              type: :text,
                              id: "user_nickname",
                              value: @user.nickname,
                              placeholder: "익명 활동 시 표시될 닉네임",
                              maxlength: 20,
                              data: { anonymous_settings_target: "nickname", action: "input->anonymous-settings#updatePreview" },
                              class: "w-full pr-12" %>
              <button type="button"
                      data-action="click->anonymous-settings#regenerateNickname"
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-xl hover:scale-110 transition-transform"
                      title="새로운 닉네임 생성">
                <span class="text-muted-foreground hover:text-primary">&#x1F3B2;</span>
              </button>
            </div>
            <p class="text-xs text-muted-foreground">2~20자 이내로 입력하세요</p>
          </div>

          <%# 익명 프로필 선택 %>
          <div class="space-y-2">
            <%= render_label name: "user[avatar_type]", label: "익명 프로필" %>
            <div class="flex justify-start gap-3">
              <% (0..3).each do |index| %>
                <button type="button"
                        data-anonymous-settings-target="avatar"
                        data-avatar-index="<%= index %>"
                        data-action="click->anonymous-settings#selectAvatar"
                        class="w-14 h-14 rounded-full overflow-hidden transition-all duration-200 cursor-pointer
                               flex items-center justify-center bg-white border border-gray-200
                               <%= @user.avatar_type == index ? 'ring-4 ring-primary/50 scale-110' : 'opacity-60 grayscale hover:opacity-100 hover:grayscale-0' %>"
                        aria-label="익명 프로필 <%= index + 1 %> 선택">
                  <%= image_tag "/anonymous#{index + 1}-.png",
                                alt: "익명 아바타 #{index + 1}",
                                class: "w-full h-full object-cover" %>
                </button>
              <% end %>
            </div>
            <%= f.hidden_field :avatar_type,
                               value: @user.avatar_type || 0,
                               data: { anonymous_settings_target: "avatarInput" } %>
            <p class="text-xs text-muted-foreground">
              익명 모드에서 사용할 아바타를 선택하세요
            </p>
          </div>
        </div>

        <%# 안내 메시지 %>
        <div class="text-xs text-muted-foreground bg-secondary/50 rounded-lg p-3">
          <p class="font-medium text-foreground mb-1">익명 모드란?</p>
          <ul class="space-y-1">
            <li>- 게시글, 댓글, 채팅에서 닉네임으로 표시됩니다</li>
            <li>- 다른 사용자가 내 프로필을 볼 때 제한된 정보만 보입니다</li>
            <li>- 언제든지 실명 모드로 전환할 수 있습니다</li>
          </ul>
        </div>
      </div>

      <!-- Cover Image - 이미지 미리보기 기능 -->
      <div class="rounded-xl border bg-card text-card-foreground p-6"
           data-controller="image-preview"
           data-image-preview-max-size-value="5242880">
        <h3 class="text-lg font-semibold mb-4">커버 이미지</h3>
        <p class="text-sm text-muted-foreground mb-4">프로필 상단에 표시되는 배경 이미지입니다.</p>

        <%# 커버 이미지 미리보기 영역 %>
        <div class="mb-4 rounded-xl overflow-hidden h-32 relative">
          <% if @user.has_cover_image? %>
            <%= image_tag @user.cover_image, alt: "현재 커버 이미지",
                          class: "w-full h-full object-cover",
                          data: { image_preview_target: "preview" } %>
          <% else %>
            <%# 기존 이미지가 없을 때 placeholder + 미리보기 이미지 %>
            <div class="w-full h-full bg-gradient-to-r <%= @user.cover_gradient %>"
                 data-image-preview-target="placeholder">
              <div class="absolute inset-0 flex items-center justify-center text-stone-400 text-sm">
                기본 그라디언트 (커버 이미지를 업로드하면 변경됩니다)
              </div>
            </div>
            <img src="" alt="커버 미리보기" class="w-full h-full object-cover absolute inset-0 hidden"
                 data-image-preview-target="preview">
          <% end %>
        </div>

        <div class="flex-1">
          <label class="block mb-2">
            <span class="text-sm font-medium text-foreground">새 커버 이미지 업로드</span>
            <%= f.file_field :cover_image,
                accept: "image/jpeg,image/png,image/gif,image/webp",
                data: { image_preview_target: "input", action: "change->image-preview#preview" },
                class: "mt-2 block w-full text-sm text-muted-foreground
                       file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                       file:text-sm file:font-medium file:bg-primary file:text-primary-foreground
                       hover:file:bg-primary/90 file:cursor-pointer cursor-pointer" %>
          </label>
          <p class="text-xs text-muted-foreground">JPG, PNG, GIF, WebP (최대 5MB). 권장 크기: 1200x400px</p>
        </div>
      </div>

      <!-- Basic Info -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">기본 정보</h3>

        <!-- Name Field -->
        <div class="space-y-2">
          <%= render_label name: "user[name]", label: "이름 *" %>
          <%= render_input name: "user[name]",
                          type: :text,
                          id: "user_name",
                          value: @user.name,
                          required: true,
                          class: "w-full" %>
        </div>

        <!-- Email (Read Only) -->
        <div class="space-y-2">
          <%= render_label name: "email", label: "이메일" %>
          <%= render_input name: "email",
                          type: :email,
                          id: "user_email",
                          value: @user.email,
                          disabled: true,
                          class: "w-full bg-muted cursor-not-allowed" %>
          <p class="text-xs text-muted-foreground">이메일은 변경할 수 없습니다</p>
        </div>

        <!-- Affiliation -->
        <div class="space-y-2">
          <%= render_label name: "user[affiliation]", label: "소속" %>
          <%= render_input name: "user[affiliation]",
                          type: :text,
                          id: "user_affiliation",
                          value: @user.affiliation,
                          placeholder: "예: 21학번/CS, 스타트업 재직중, 프리랜서",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">이름 옆에 표시됩니다</p>
        </div>

        <!-- Role Title -->
        <div class="space-y-2">
          <%= render_label name: "user[role_title]", label: "직군/역할" %>
          <%= render_input name: "user[role_title]",
                          type: :text,
                          id: "user_role_title",
                          value: @user.role_title,
                          placeholder: "예: 백엔드 개발자, UI/UX 디자이너, PM",
                          class: "w-full" %>
        </div>

        <!-- Bio (한 줄) -->
        <div class="space-y-2">
          <%= render_label name: "user[bio]", label: "한 줄 소개" %>
          <%= render_textarea name: "user[bio]",
                             id: "user_bio",
                             value: @user.bio,
                             placeholder: "빠르게 MVP 만들어서 검증하는 개발자입니다.",
                             rows: 2,
                             class: "w-full resize-none" %>
          <p class="text-xs text-muted-foreground">프로필에 인용문처럼 표시됩니다 (최대 500자)</p>
        </div>
      </div>

      <!-- Detailed Bio (상세 소개 - Rich Text) -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold">상세 소개</h3>
        <p class="text-sm text-muted-foreground">본인을 자세히 소개해보세요. 서식을 적용할 수 있습니다.</p>

        <div class="space-y-2">
          <%= f.label :detailed_bio, "자기소개", class: "block text-sm font-medium text-foreground" %>
          <div class="trix-content-wrapper rounded-lg border border-border overflow-hidden bg-background">
            <%= f.rich_text_area :detailed_bio,
                                 class: "w-full min-h-[200px] focus:outline-none",
                                 placeholder: "경험, 관심사, 작업 방식 등을 자유롭게 적어주세요..." %>
          </div>
          <p class="text-xs text-muted-foreground">이미지 첨부, 링크, 목록 등 서식을 활용해보세요</p>
        </div>
      </div>

      <!-- Status Message & Context (NEW: Persona Canvas) -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">프로필 컨텍스트</h3>
        <p class="text-sm text-muted-foreground mb-4">다른 사람들이 당신을 더 잘 이해할 수 있도록 도와주세요.</p>

        <!-- Status Message -->
        <div class="space-y-2">
          <%= render_label name: "user[status_message]", label: "현재 상태" %>
          <%= render_input name: "user[status_message]",
                          type: :text,
                          id: "user_status_message",
                          value: @user.status_message,
                          placeholder: "예: 사이드 프로젝트 찾는 중, 이직 준비 중",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">프로필에서 이름 아래에 표시됩니다 (최대 100자)</p>
        </div>

        <!-- Looking For -->
        <div class="space-y-2">
          <%= render_label name: "user[looking_for]", label: "찾는 것" %>
          <%= render_input name: "user[looking_for]",
                          type: :text,
                          id: "user_looking_for",
                          value: @user.looking_for,
                          placeholder: "예: AI 서비스 기획자, 초기 스타트업 마케팅 관심",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">협업하고 싶은 사람이나 관심 분야를 적어주세요 (최대 200자)</p>
        </div>

        <!-- Location -->
        <div class="space-y-2">
          <%= render_label name: "user[location]", label: "활동 지역" %>
          <%= render_input name: "user[location]",
                          type: :text,
                          id: "user_location",
                          value: @user.location,
                          placeholder: "예: 서울 강남, 판교, 리모트",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">주로 활동하는 지역입니다 (최대 50자)</p>
        </div>
      </div>

      <!-- Activity Status -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">활동 상태</h3>
        <p class="text-sm text-muted-foreground mb-4">현재 상태를 표시하여 다른 사용자들에게 연락 가능 여부를 알려주세요.</p>

        <div class="space-y-3">
          <% User::AVAILABILITY_OPTIONS.each do |key, option| %>
            <label class="flex items-center gap-3 p-4 rounded-lg border border-border hover:bg-secondary/50 cursor-pointer transition-colors <%= @user.has_status?(key) ? 'bg-secondary/50 border-primary' : '' %>">
              <input type="checkbox"
                     name="user[availability_statuses][]"
                     value="<%= key %>"
                     <%= 'checked' if @user.has_status?(key) %>
                     class="h-5 w-5 rounded border-border text-primary focus:ring-primary">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-medium"><%= option[:label] %></span>
                  <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold text-white <%= option[:color] %>">
                    <span class="h-1.5 w-1.5 rounded-full bg-white"></span>
                    <%= option[:label] %>
                  </span>
                </div>
              </div>
            </label>
          <% end %>
        </div>

        <!-- Custom Status -->
        <div class="mt-4 pt-4 border-t border-border space-y-2" data-controller="custom-status-preview">
          <%= render_label name: "user[custom_status]", label: "기타 상태 (직접 입력)" %>
          <div class="flex items-center gap-3">
            <%= render_input name: "user[custom_status]",
                            type: :text,
                            id: "user_custom_status",
                            value: @user.custom_status,
                            placeholder: "예: 재직 중, 학생",
                            data: { custom_status_preview_target: "input", action: "input->custom-status-preview#update" },
                            class: "flex-1" %>
            <span data-custom-status-preview-target="preview" class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-semibold text-white bg-pink-500 <%= @user.custom_status.blank? ? 'hidden' : '' %>">
              <span class="h-1.5 w-1.5 rounded-full bg-white animate-pulse"></span>
              <span data-custom-status-preview-target="badge"><%= @user.custom_status %></span>
            </span>
          </div>
          <p class="text-xs text-muted-foreground">원하는 상태를 직접 입력하세요 (최대 10자)</p>
        </div>

        <!-- Hidden field to ensure empty array is sent when nothing is checked -->
        <input type="hidden" name="user[availability_statuses][]" value="">
      </div>

      <!-- Skills -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">기술 스택</h3>

        <div class="space-y-2">
          <%= render_label name: "user[skills]", label: "기술/키워드" %>
          <%= render_input name: "user[skills]",
                          type: :text,
                          id: "user_skills",
                          value: @user.skills,
                          placeholder: "React, Node.js, Figma, 시장분석",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">쉼표(,)로 구분하여 입력하세요. 프로필에 태그로 표시됩니다.</p>
        </div>

        <% if @user.skills_array.any? %>
          <div>
            <p class="text-sm font-medium text-foreground mb-2">현재 등록된 기술:</p>
            <div class="flex flex-wrap gap-2">
              <% @user.skills_array.each do |skill| %>
                <%= render_badge skill, variant: :secondary %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Toolbox & Learning -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">도구 & 성장</h3>
        <p class="text-sm text-muted-foreground mb-4">주로 사용하는 도구와 요즘 관심사를 공유하세요.</p>

        <!-- Toolbox -->
        <div class="space-y-2">
          <%= render_label name: "user[toolbox]", label: "사용 도구 & 장비" %>
          <%= render_input name: "user[toolbox]",
                          type: :text,
                          id: "user_toolbox",
                          value: @user.toolbox,
                          placeholder: "예: MacBook Pro, Figma, Notion, VSCode (쉼표로 구분)",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">주로 사용하는 도구와 장비를 쉼표로 구분해 입력하세요</p>
        </div>

        <% if @user.toolbox_array.any? %>
          <div>
            <p class="text-sm font-medium text-foreground mb-2">등록된 도구:</p>
            <div class="flex flex-wrap gap-2">
              <% @user.toolbox_array.each do |tool| %>
                <%= render_badge tool, variant: :outline %>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Currently Learning -->
        <div class="space-y-2 pt-4 border-t border-border">
          <%= render_label name: "user[currently_learning]", label: "요즘 배우는 것" %>
          <%= render_textarea name: "user[currently_learning]",
                             id: "user_currently_learning",
                             value: @user.currently_learning,
                             placeholder: "예: AI/ML 기초, 린 스타트업 방법론, 프롬프트 엔지니어링",
                             rows: 2,
                             class: "w-full resize-none" %>
          <p class="text-xs text-muted-foreground">최근 학습하고 있거나 관심 있는 분야를 적어주세요</p>
        </div>
      </div>

      <!-- Experience Timeline (경력 & 경험) -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4"
           data-controller="experience-form">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold">경력 & 경험</h3>
            <p class="text-sm text-muted-foreground">경력, 학력, 프로젝트 등을 추가하세요.</p>
          </div>
          <button type="button"
                  data-action="experience-form#add"
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium
                         bg-primary text-primary-foreground rounded-lg
                         hover:bg-primary/90 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            추가
          </button>
        </div>

        <%# 경험 목록 컨테이너 %>
        <div data-experience-form-target="list" class="space-y-4">
          <% (@user.experiences_array.presence || []).each_with_index do |exp, index| %>
            <div class="p-4 rounded-xl border border-border bg-secondary/30 relative group"
                 data-experience-form-target="item">
              <%# 삭제 버튼 %>
              <button type="button"
                      data-action="experience-form#remove"
                      class="absolute -top-2 -right-2 w-6 h-6 bg-destructive text-destructive-foreground
                             rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100
                             transition-opacity hover:scale-110">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>

              <div class="grid grid-cols-2 gap-4">
                <%# 경험 타입 %>
                <div class="col-span-2 sm:col-span-1">
                  <label class="block text-xs font-medium text-foreground mb-1">타입</label>
                  <select name="user[experiences][][type]"
                          class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                 focus:outline-none focus:ring-2 focus:ring-primary/20">
                    <% User::EXPERIENCE_TYPES.each do |key, info| %>
                      <option value="<%= key %>" <%= 'selected' if exp["type"] == key %>><%= info[:label] %></option>
                    <% end %>
                  </select>
                </div>

                <%# 현재 진행 중 %>
                <div class="col-span-2 sm:col-span-1 flex items-end">
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox"
                           name="user[experiences][][is_current]"
                           value="true"
                           <%= 'checked' if exp["is_current"] %>
                           class="h-4 w-4 rounded border-border text-primary focus:ring-primary">
                    <span class="text-sm font-medium">현재 진행 중</span>
                  </label>
                </div>

                <%# 제목 %>
                <div class="col-span-2">
                  <label class="block text-xs font-medium text-foreground mb-1">제목 *</label>
                  <input type="text"
                         name="user[experiences][][title]"
                         value="<%= exp["title"] %>"
                         placeholder="예: 백엔드 개발자, 컴퓨터공학 학사"
                         required
                         class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
                </div>

                <%# 조직/회사/학교 %>
                <div class="col-span-2 sm:col-span-1">
                  <label class="block text-xs font-medium text-foreground mb-1">조직/회사/학교</label>
                  <input type="text"
                         name="user[experiences][][organization]"
                         value="<%= exp["organization"] %>"
                         placeholder="예: 스타트업 A, 서울대학교"
                         class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
                </div>

                <%# 기간 %>
                <div class="col-span-2 sm:col-span-1">
                  <label class="block text-xs font-medium text-foreground mb-1">기간</label>
                  <input type="text"
                         name="user[experiences][][period]"
                         value="<%= exp["period"] %>"
                         placeholder="예: 2023.03 - 현재"
                         class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
                </div>

                <%# 설명 %>
                <div class="col-span-2">
                  <label class="block text-xs font-medium text-foreground mb-1">설명</label>
                  <textarea name="user[experiences][][description]"
                            placeholder="주요 업무나 성과를 간단히 적어주세요"
                            rows="2"
                            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                   placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20
                                   resize-none"><%= exp["description"] %></textarea>
                </div>

                <%# 정렬 순서 (hidden) %>
                <input type="hidden" name="user[experiences][][sort_order]" value="<%= index %>">
              </div>
            </div>
          <% end %>
        </div>

        <%# 빈 상태 %>
        <div data-experience-form-target="empty"
             class="<%= @user.experiences_array.any? ? 'hidden' : '' %>
                    text-center py-8 text-muted-foreground">
          <svg class="w-12 h-12 mx-auto mb-3 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-sm">아직 등록된 경험이 없습니다</p>
          <p class="text-xs mt-1">위의 "추가" 버튼을 클릭하여 경력, 학력, 프로젝트를 추가하세요</p>
        </div>

        <%# 템플릿 (Stimulus에서 클론해서 사용) %>
        <template data-experience-form-target="template">
          <div class="p-4 rounded-xl border border-border bg-secondary/30 relative group"
               data-experience-form-target="item">
            <button type="button"
                    data-action="experience-form#remove"
                    class="absolute -top-2 -right-2 w-6 h-6 bg-destructive text-destructive-foreground
                           rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100
                           transition-opacity hover:scale-110">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>

            <div class="grid grid-cols-2 gap-4">
              <div class="col-span-2 sm:col-span-1">
                <label class="block text-xs font-medium text-foreground mb-1">타입</label>
                <select name="user[experiences][][type]"
                        class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                               focus:outline-none focus:ring-2 focus:ring-primary/20">
                  <% User::EXPERIENCE_TYPES.each do |key, info| %>
                    <option value="<%= key %>"><%= info[:label] %></option>
                  <% end %>
                </select>
              </div>

              <div class="col-span-2 sm:col-span-1 flex items-end">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox"
                         name="user[experiences][][is_current]"
                         value="true"
                         class="h-4 w-4 rounded border-border text-primary focus:ring-primary">
                  <span class="text-sm font-medium">현재 진행 중</span>
                </label>
              </div>

              <div class="col-span-2">
                <label class="block text-xs font-medium text-foreground mb-1">제목 *</label>
                <input type="text"
                       name="user[experiences][][title]"
                       placeholder="예: 백엔드 개발자, 컴퓨터공학 학사"
                       required
                       class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                              placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
              </div>

              <div class="col-span-2 sm:col-span-1">
                <label class="block text-xs font-medium text-foreground mb-1">조직/회사/학교</label>
                <input type="text"
                       name="user[experiences][][organization]"
                       placeholder="예: 스타트업 A, 서울대학교"
                       class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                              placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
              </div>

              <div class="col-span-2 sm:col-span-1">
                <label class="block text-xs font-medium text-foreground mb-1">기간</label>
                <input type="text"
                       name="user[experiences][][period]"
                       placeholder="예: 2023.03 - 현재"
                       class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                              placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20">
              </div>

              <div class="col-span-2">
                <label class="block text-xs font-medium text-foreground mb-1">설명</label>
                <textarea name="user[experiences][][description]"
                          placeholder="주요 업무나 성과를 간단히 적어주세요"
                          rows="2"
                          class="w-full rounded-lg border border-border bg-background px-3 py-2 text-sm
                                 placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/20
                                 resize-none"></textarea>
              </div>

              <input type="hidden" name="user[experiences][][sort_order]" value="0">
            </div>
          </div>
        </template>
      </div>

      <!-- Related Links -->
      <div class="rounded-xl border bg-card text-card-foreground p-6 space-y-4">
        <h3 class="text-lg font-semibold mb-4">관련 링크</h3>
        <p class="text-sm text-muted-foreground mb-4">나를 더 알릴 수 있는 링크를 추가하세요.</p>

        <!-- LinkedIn URL -->
        <div class="space-y-2">
          <%= render_label name: "user[linkedin_url]", label: "LinkedIn" %>
          <%= render_input name: "user[linkedin_url]",
                          type: :url,
                          id: "user_linkedin_url",
                          value: @user.linkedin_url,
                          placeholder: "https://linkedin.com/in/username",
                          class: "w-full" %>
        </div>

        <!-- GitHub URL -->
        <div class="space-y-2">
          <%= render_label name: "user[github_url]", label: "GitHub" %>
          <%= render_input name: "user[github_url]",
                          type: :url,
                          id: "user_github_url",
                          value: @user.github_url,
                          placeholder: "https://github.com/username",
                          class: "w-full" %>
        </div>

        <!-- Portfolio URL -->
        <div class="space-y-2">
          <%= render_label name: "user[portfolio_url]", label: "포트폴리오" %>
          <%= render_input name: "user[portfolio_url]",
                          type: :url,
                          id: "user_portfolio_url",
                          value: @user.portfolio_url,
                          placeholder: "https://notion.so/..., https://behance.net/...",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">노션, 비핸스, 개인 웹사이트 등</p>
        </div>

        <!-- Open Chat URL -->
        <div class="space-y-2">
          <%= render_label name: "user[open_chat_url]", label: "오픈채팅" %>
          <%= render_input name: "user[open_chat_url]",
                          type: :url,
                          id: "user_open_chat_url",
                          value: @user.open_chat_url,
                          placeholder: "https://open.kakao.com/o/...",
                          class: "w-full" %>
          <p class="text-xs text-muted-foreground">카카오톡 오픈채팅 등 빠른 연락처</p>
        </div>
      </div>

    <% end %>
  </main>

  <%= render "shared/bottom_nav" %>
</div>
