<%# Turbo Stream 구독 (분석 완료 시 자동 업데이트) %>
<%= turbo_stream_from "idea_analysis_#{@idea_analysis.id}" %>

<div class="min-h-screen bg-background flex flex-col pb-20"
     data-controller="ai-result ai-loading accordion"
     data-ai-result-idea-value="<%= @idea %>"
     data-ai-loading-status-value="<%= @idea_analysis.status %>">

  <%# 분석 중일 때 로딩 오버레이 - 단계별 원형 프로그레스 바 %>
  <% if @idea_analysis.analyzing? %>
    <div data-ai-loading-target="overlay"
         class="fixed inset-0 z-50 bg-background/90 backdrop-blur-md flex items-center justify-center transition-opacity duration-500">
      <div class="text-center space-y-8 max-w-sm mx-auto px-6">

        <%# 단계별 원형 프로그레스 바 (Turbo Stream으로 업데이트됨) %>
        <div id="ai_loading_progress">
          <%= render "onboarding/loading_progress",
                     current_stage: @idea_analysis.current_stage,
                     total_stages: IdeaAnalysis::TOTAL_STAGES,
                     stage_name: IdeaAnalysis::STAGE_NAMES[@idea_analysis.current_stage] %>
        </div>

        <%# 메시지 %>
        <div class="space-y-3">
          <h2 class="text-xl font-bold text-foreground">
            <% if current_user %>
              <%= current_user.name %>님을 위한<br/>분석 리포트 생성 중
            <% else %>
              AI 분석 리포트 생성 중
            <% end %>
          </h2>
          <p class="text-sm text-muted-foreground leading-relaxed">
            5개 전문 에이전트가 아이디어를 분석하고 있어요
          </p>
        </div>

        <%# 예상 소요 시간 %>
        <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-secondary/50 text-xs text-muted-foreground">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>예상 소요 시간: 10~30초</span>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Header: Undrew AI Branding -->
  <header class="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-40">
    <div class="max-w-screen-xl mx-auto px-4 py-4 flex items-center gap-3">
      <%= render_button variant: :ghost, class: "h-9 w-9 p-0", data: { controller: "navigation", action: "click->navigation#goBack" } do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      <% end %>

      <!-- Undrew AI Logo -->
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-lg overflow-hidden flex items-center justify-center">
          <img src="/undrew_icon_only.png" alt="Undrew" class="w-8 h-8 object-contain">
        </div>
        <div>
          <span class="font-bold text-foreground">Undrew AI</span>
          <span class="text-sm text-muted-foreground ml-1">아이디어 분석 결과</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-screen-xl mx-auto w-full px-4 py-6">
    <!-- Progress Indicator -->
    <div class="flex items-center justify-center gap-2 mb-6">
      <div class="h-2 w-8 rounded-full bg-primary"></div>
      <div class="h-2 w-8 rounded-full bg-primary"></div>
      <div class="h-2 w-8 rounded-full bg-primary"></div>
    </div>

    <!-- Result Content (Turbo Stream으로 교체됨) -->
    <div id="ai_result_content"
         class="<%= 'blur-sm pointer-events-none select-none' if @idea_analysis.analyzing? %>"
         data-ai-loading-target="content">
      <%= render "onboarding/ai_result_content",
                 idea_analysis: @idea_analysis,
                 analysis: @analysis || {},
                 recommended_experts: @recommended_experts || [] %>
    </div>
  </main>
</div>
