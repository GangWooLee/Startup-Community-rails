<div class="min-h-screen bg-background pb-20">
  <!-- Header -->
  <header class="sticky top-0 bg-background/95 backdrop-blur-sm border-b border-border z-40">
    <div class="max-w-screen-xl mx-auto px-4 py-3 flex items-center justify-between">
<%= render_button variant: :ghost, class: "h-9 w-9 p-0", data: { controller: "navigation", navigation_fallback_value: post_path(@post), action: "click->navigation#goBack" } do %>
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      <% end %>

      <h1 class="text-lg font-semibold">글 수정</h1>

      <button
        type="submit"
        form="post-form"
        id="submit-button"
        class="px-4 py-1.5 rounded-full bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        저장
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-screen-xl mx-auto px-4 py-6" data-controller="post-form">
    <%= form_with model: @post, id: "post-form", local: true, html: { multipart: true }, data: { action: "input->post-form#validateForm" } do |f| %>
      <% if @post.errors.any? %>
        <div class="mb-6 p-4 rounded-lg bg-destructive/10 border border-destructive/20">
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-destructive flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <p class="text-sm font-medium text-destructive">입력 오류가 있습니다</p>
              <ul class="mt-1 text-sm text-destructive/80 list-disc list-inside">
                <% @post.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>

      <div class="space-y-4">
        <% if @initial_type == 'outsourcing' %>
          <!-- 외주: 구인/구직 선택 (컴팩트 버전) -->
          <div class="flex gap-2">
            <label class="flex-1 relative cursor-pointer">
              <%= f.radio_button :category, 'hiring',
                  checked: @post.hiring?,
                  class: "peer sr-only",
                  data: { post_form_target: "category", action: "change->post-form#toggleCategoryFields" } %>
              <div class="flex items-center justify-center gap-2 py-2.5 px-4 rounded-lg border-2 border-border transition-all peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50">
                <svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span class="text-sm font-medium text-foreground">구인</span>
                <span class="text-xs text-muted-foreground hidden sm:inline">사람을 찾아요</span>
              </div>
            </label>
            <label class="flex-1 relative cursor-pointer">
              <%= f.radio_button :category, 'seeking',
                  checked: @post.seeking?,
                  class: "peer sr-only",
                  data: { post_form_target: "category", action: "change->post-form#toggleCategoryFields" } %>
              <div class="flex items-center justify-center gap-2 py-2.5 px-4 rounded-lg border-2 border-border transition-all peer-checked:border-primary peer-checked:bg-primary/5 hover:border-primary/50">
                <svg class="h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-sm font-medium text-foreground">구직</span>
                <span class="text-xs text-muted-foreground hidden sm:inline">일 해드려요</span>
              </div>
            </label>
          </div>
        <% else %>
          <!-- 커뮤니티: 기존 카테고리 유지 -->
          <%= f.hidden_field :category %>
        <% end %>
        <!-- Title -->
        <div class="rounded-xl border bg-card text-card-foreground p-4">
          <%= f.text_field :title,
              placeholder: "제목을 입력하세요",
              data: { post_form_target: "title" },
              class: "w-full bg-transparent text-foreground text-lg font-medium placeholder:text-muted-foreground focus:outline-none border-none" %>
        </div>

        <!-- Content -->
        <div class="rounded-xl border bg-card text-card-foreground p-4">
          <%= f.text_area :content,
              placeholder: "창업 아이디어, 개발 고민, 팀 빌딩 등 자유롭게 이야기해보세요.",
              rows: 12,
              data: { post_form_target: "content" },
              class: "w-full bg-transparent text-foreground placeholder:text-muted-foreground focus:outline-none resize-none border-none" %>
        </div>

        <!-- Image Upload (기존 이미지 + 새 이미지 통합) -->
        <div class="rounded-xl border bg-card text-card-foreground p-4" data-controller="image-upload" data-image-upload-existing-count-value="<%= @post.images.attached? ? @post.images.count : 0 %>">
          <div class="flex items-center justify-between mb-3">
            <label class="flex items-center text-sm font-medium text-foreground">
              <svg class="h-5 w-5 mr-2 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              첨부 이미지
            </label>
            <span id="image-counter" class="text-xs text-muted-foreground" data-image-upload-target="counter"><%= @post.images.attached? ? @post.images.count : 0 %>/5</span>
          </div>

          <!-- Image Preview Area (기존 + 새 이미지) -->
          <div
            data-image-upload-target="preview"
            class="grid grid-cols-3 gap-2 mb-3 <%= @post.images.attached? ? '' : 'empty:hidden' %>"
          >
            <!-- 기존 이미지 -->
            <% if @post.images.attached? %>
              <% @post.images.attachments.each do |attachment| %>
                <div id="image-<%= attachment.id %>"
                     class="relative aspect-square rounded-lg overflow-hidden bg-secondary"
                     data-image-upload-target="existingImage"
                     data-controller="image-delete"
                     data-image-delete-url-value="<%= remove_image_post_path(@post, image_id: attachment.id) %>">
                  <%= image_tag attachment, class: "w-full h-full object-cover", alt: "첨부 이미지" %>
                  <button type="button"
                          class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-black/60 rounded-full text-white hover:bg-black/80 transition-colors"
                          data-action="click->image-delete#delete">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              <% end %>
            <% end %>
            <!-- 새 이미지는 JavaScript로 추가됨 -->
          </div>

          <!-- Upload Button -->
          <label class="flex items-center justify-center gap-2 p-4 border-2 border-dashed border-border rounded-lg cursor-pointer hover:border-primary/50 hover:bg-secondary/30 transition-colors" data-image-upload-target="dropzone">
            <svg class="h-6 w-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            <span class="text-sm text-muted-foreground">사진 추가</span>
            <%= f.file_field :images,
                multiple: true,
                accept: "image/*",
                class: "hidden",
                data: { image_upload_target: "input", action: "change->image-upload#handleFiles" } %>
          </label>

          <p class="mt-2 text-xs text-muted-foreground text-center">JPG, PNG, GIF (각 10MB 이하, 최대 5장)</p>
        </div>

        <!-- Outsourcing Fields (외주용) -->
        <% if @initial_type == 'outsourcing' %>
          <!-- 공통 필드 -->
          <div class="rounded-xl border bg-card text-card-foreground p-4 space-y-4" data-post-form-target="outsourcingFields">
            <h3 class="text-sm font-medium text-foreground">외주 정보</h3>

            <!-- Service Type -->
            <div>
              <%= f.label :service_type, "서비스 분야", class: "block text-sm text-muted-foreground mb-2" %>
              <%= f.select :service_type,
                  options_for_select(Post::SERVICE_TYPES.map { |k, v| [v, k] }, @post.service_type),
                  { include_blank: "분야 선택" },
                  { class: "w-full px-4 py-3 rounded-lg border border-border bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-ring",
                    data: { post_form_target: "serviceType", action: "change->post-form#validateForm" } } %>
            </div>

            <!-- Skills (공통) -->
            <div>
              <%= f.label :skills, "필요 기술 / 보유 기술", class: "block text-sm text-muted-foreground mb-2" %>
              <%= f.text_field :skills,
                  placeholder: "예: React, Node.js, Figma (쉼표로 구분)",
                  class: "w-full px-4 py-3 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring" %>
            </div>

            <!-- Work Type (공통) -->
            <div>
              <span class="block text-sm text-muted-foreground mb-2">진행 방식</span>
              <div class="flex flex-wrap gap-2">
                <% Post::WORK_TYPES.each do |key, label| %>
                  <label class="relative cursor-pointer">
                    <%= f.radio_button :work_type, key, checked: @post.work_type == key, class: "peer sr-only" %>
                    <div class="px-4 py-2 rounded-lg border border-border text-sm transition-all peer-checked:border-primary peer-checked:bg-primary/5 peer-checked:text-primary hover:border-primary/50">
                      <%= label %>
                    </div>
                  </label>
                <% end %>
              </div>
            </div>

            <!-- Price -->
            <div>
              <%= f.label :price, "예산/금액", class: "block text-sm text-muted-foreground mb-2" %>
              <div class="flex items-center gap-3">
                <div class="relative flex-1">
                  <span class="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground">₩</span>
                  <%= f.number_field :price,
                      placeholder: "0",
                      min: 0,
                      class: "w-full pl-10 pr-4 py-3 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring" %>
                </div>
                <label class="flex items-center gap-2 whitespace-nowrap cursor-pointer">
                  <%= f.check_box :price_negotiable, class: "h-5 w-5 rounded border-border text-primary focus:ring-primary" %>
                  <span class="text-sm text-muted-foreground">협의 가능</span>
                </label>
              </div>
            </div>

            <!-- Work Period -->
            <div>
              <%= f.label :work_period, "예상 기간", class: "block text-sm text-muted-foreground mb-2" %>
              <%= f.text_field :work_period,
                  placeholder: "예: 1주일, 2025년 1월까지",
                  class: "w-full px-4 py-3 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring" %>
            </div>
          </div>

          <!-- 구직(Seeking) 전용 필드 -->
          <div class="rounded-xl border bg-card text-card-foreground p-4 space-y-4 <%= @post.seeking? ? '' : 'hidden' %>" data-post-form-target="seekingFields">
            <h3 class="text-sm font-medium text-foreground">구직자 정보</h3>

            <!-- Portfolio URL -->
            <div>
              <%= f.label :portfolio_url, "포트폴리오 링크", class: "block text-sm text-muted-foreground mb-2" %>
              <%= f.url_field :portfolio_url,
                  placeholder: "https://your-portfolio.com",
                  class: "w-full px-4 py-3 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring" %>
            </div>

            <!-- Available Now Toggle -->
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-foreground">작업 가능 상태</span>
                <p class="text-xs text-muted-foreground">현재 새로운 프로젝트를 받을 수 있나요?</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <%= f.check_box :available_now,
                    class: "sr-only peer",
                    checked: @post.available_now.nil? ? true : @post.available_now %>
                <div class="w-11 h-6 bg-muted-foreground/30 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-ring rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-border after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>

            <!-- Experience -->
            <div>
              <%= f.label :experience, "관련 경험/이력", class: "block text-sm text-muted-foreground mb-2" %>
              <%= f.text_area :experience,
                  placeholder: "관련 프로젝트 경험이나 이력을 간단히 적어주세요",
                  rows: 3,
                  class: "w-full px-4 py-3 rounded-lg border border-border bg-background text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none" %>
            </div>
          </div>
        <% end %>

        <!-- Delete Button -->
        <div class="pt-4 border-t border-border">
          <%= button_to "게시글 삭제", post_path(@post),
              method: :delete,
              form: { data: { turbo_confirm: "정말 삭제하시겠습니까?" } },
              class: "w-full py-3 rounded-lg border border-destructive text-destructive hover:bg-destructive hover:text-destructive-foreground transition-colors" %>
        </div>
      </div>
    <% end %>
  </main>
</div>
