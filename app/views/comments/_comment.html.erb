<% comment = local_assigns[:comment] %>
<% post = local_assigns[:post] %>
<% current_user = local_assigns[:current_user] %>
<% is_reply = comment.reply? %>
<% depth = local_assigns.fetch(:depth, 0) %>
<% replies_count = comment.replies.count %>

<%# 3단 Flexbox 구조: [아바타] - [콘텐츠] - [좋아요 버튼] %>
<div id="comment-<%= comment.id %>"
     class="<%= is_reply ? 'pl-11 mt-3' : 'py-3' %>"
     data-controller="reply-toggle">
  <div class="flex items-start gap-3">
    <%# 1. 좌측: 아바타 영역 (Fixed Width 40px, 대댓글은 32px) %>
    <%= link_to profile_path(comment.user), class: "flex-shrink-0" do %>
      <%= render partial: "shared/avatar", locals: { user: comment.user, size: is_reply ? "sm" : "md" } %>
    <% end %>

    <%# 2. 중앙: 콘텐츠 영역 (Flex-Grow: 1, 가변) %>
    <div class="flex-1 min-w-0">
      <%# [A] 유저네임 + 댓글 내용 (Inline) %>
      <p class="text-sm leading-snug">
        <%= link_to comment.user.name, profile_path(comment.user), class: "font-semibold text-foreground hover:underline mr-1" %><span class="text-foreground break-words"><%= comment.content %></span>
      </p>

      <%# [B] 메타데이터 Row: 시간 - 좋아요 수 - 답글 달기 - 삭제 %>
      <div class="flex items-center gap-3 mt-1">
        <span class="text-xs text-muted-foreground"><%= time_ago_in_words(comment.created_at) %></span>

        <% if comment.likes_count > 0 %>
          <span id="comment-likes-count-<%= comment.id %>" class="inline-flex items-center gap-1 text-xs font-medium text-muted-foreground">
            <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 24 24">
              <path d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
            </svg>
            <span data-comment-likes-count><%= comment.likes_count %>개</span>
          </span>
        <% end %>

        <% if current_user && !is_reply && depth < 1 %>
          <button type="button"
                  data-action="click->reply-toggle#toggle"
                  class="text-xs font-medium text-muted-foreground hover:text-foreground transition-colors">
            답글 달기
          </button>
        <% end %>

        <% if current_user && comment.user_id == current_user.id %>
          <%= button_to post_comment_path(post, comment),
              method: :delete,
              class: "text-xs font-medium text-muted-foreground hover:text-destructive transition-colors",
              data: { turbo_confirm: "정말 삭제하시겠습니까?" } do %>
            삭제
          <% end %>
        <% end %>
      </div>

      <%# 답글 보기 버튼 (대댓글이 있을 때만, 최상위 댓글만) %>
      <% if !is_reply && replies_count > 0 %>
        <div class="mt-2" data-reply-toggle-target="repliesToggle">
          <button type="button"
                  data-action="click->reply-toggle#toggleReplies"
                  class="flex items-center gap-2 text-xs font-medium text-muted-foreground hover:text-foreground transition-colors group">
            <span class="w-6 h-px bg-muted-foreground/50"></span>
            <span data-reply-toggle-target="repliesButtonText">답글 보기(<%= replies_count %>개)</span>
          </button>
        </div>
      <% end %>

      <%# 답글 작성 폼 %>
      <% if current_user && !is_reply && depth < 1 %>
        <div class="mt-3 hidden" data-reply-toggle-target="form">
          <%= render partial: "comments/form", locals: { post: post, parent_id: comment.id } %>
        </div>
      <% end %>

      <%# 대댓글 목록 (숨김 상태로 시작) %>
      <% if replies_count > 0 %>
        <div id="replies-<%= comment.id %>" class="mt-2 hidden" data-reply-toggle-target="replies">
          <% comment.replies.oldest.each do |reply| %>
            <%= render partial: "comments/comment", locals: {
              comment: reply,
              post: post,
              current_user: current_user,
              depth: depth + 1
            } %>
          <% end %>
        </div>
      <% else %>
        <div id="replies-<%= comment.id %>" class="mt-2" data-reply-toggle-target="replies"></div>
      <% end %>
    </div>

    <%# 3. 우측: 좋아요 버튼 (Fixed Width, 터치 영역 확보) %>
    <div class="flex-shrink-0">
      <% if current_user %>
        <%= render partial: "comments/like_button_icon", locals: {
          comment: comment,
          liked: comment.liked_by?(current_user)
        } %>
      <% else %>
        <button type="button"
                onclick="window.location.href='/login'"
                class="p-2 -m-2 text-muted-foreground hover:text-red-500 transition-colors">
          <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/>
          </svg>
        </button>
      <% end %>
    </div>
  </div>
</div>
