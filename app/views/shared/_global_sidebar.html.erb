<%#
  Global Sidebar - 데스크톱/모바일 분리 방식

  데스크톱: w-64 (펼침) ↔ w-16 (접힘) 레이아웃 내 너비 변경 (콘텐츠 밀림)
  모바일: 완전히 숨김 ↔ 오버레이로 열림 (콘텐츠 밀림 없음)

  Features:
  - expandedContent: 펼친 상태 (아이콘 + 텍스트)
  - collapsedContent: 접힌 상태 (아이콘만)
  - 데스크톱: localStorage로 상태 유지
%>

<%# 사이드바: 모바일 hidden, 데스크톱 w-64 기본 펼침 %>
<aside class="hidden md:flex md:flex-col w-64 bg-white border-r border-stone-200/60 h-screen flex-shrink-0"
       data-sidebar-collapse-target="sidebar">

    <%# Logo & Brand Header %>
    <div class="flex items-center h-16 border-b border-stone-100">

      <%# 펼친 상태: 로고 + 텍스트 + 토글 버튼 %>
      <div class="w-full flex justify-between items-center"
           data-sidebar-collapse-target="expandedContent">
        <%= link_to community_path, class: "flex items-center group" do %>
          <div class="w-[60px] flex-shrink-0 flex justify-center">
            <%= image_tag "/undrew_icon_only.png", alt: "Undrew",
                class: "w-8 h-8 rounded-xl shadow-md shadow-stone-900/10
                        group-hover:scale-105 transition-transform object-contain" %>
          </div>
          <span class="font-bold text-lg text-stone-900 tracking-tight">Undrew</span>
        <% end %>

        <%# 토글 버튼 (접기) %>
        <button type="button"
                class="p-1.5 mr-2 text-stone-400 hover:text-stone-600 hover:bg-stone-100 rounded-lg transition-colors"
                data-action="click->sidebar-collapse#toggle"
                aria-label="사이드바 접기">
          <svg class="w-5 h-5 transition-transform duration-300"
               data-sidebar-collapse-target="toggleIcon"
               fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
          </svg>
        </button>
      </div>

      <%# 접힌 상태: 로고만 (클릭하면 확장) %>
      <div class="hidden w-full items-center"
           data-sidebar-collapse-target="collapsedContent">
        <button type="button"
                class="w-[60px] flex-shrink-0 flex justify-center py-2 hover:bg-stone-50 rounded-xl transition-colors group"
                data-action="click->sidebar-collapse#toggle"
                aria-label="사이드바 펼치기">
          <%= image_tag "/undrew_icon_only.png", alt: "Undrew",
              class: "w-8 h-8 rounded-lg shadow-sm shadow-stone-900/10
                      group-hover:scale-105 transition-transform object-contain" %>
        </button>
      </div>
    </div>

    <%# Navigation - Scrollable %>
    <nav class="flex-1 overflow-y-auto py-4 px-2 space-y-6 sidebar-scroll">

      <%# Main Navigation %>
      <div class="space-y-1">
        <%# 1. Home %>
        <% is_home_active = current_page?(community_path) && params[:category].blank? && params[:sort].blank? %>
        <%= collapsible_sidebar_nav_item "홈", community_path, :home, is_active: is_home_active %>

        <%# 2. Chat (with unread badge) %>
        <% if logged_in? %>
          <% is_chat_active = controller_name == "chat_rooms" || controller_name == "messages" %>
          <%= collapsible_sidebar_nav_item "채팅", chat_rooms_path, :chat,
              is_active: is_chat_active,
              badge: unread_messages_count %>
        <% else %>
          <%= collapsible_sidebar_nav_item "채팅", login_path, :chat %>
        <% end %>

        <%# 3. AI Analysis %>
        <% is_ai_active = current_page?(onboarding_ai_input_path) || request.path.start_with?("/ai/result") rescue false %>
        <%= collapsible_sidebar_nav_item "AI 분석", onboarding_ai_input_path, :ai, is_active: is_ai_active %>

        <%# 4. Join Project %>
        <%= collapsible_sidebar_nav_item "Join Project", job_posts_path, :rocket %>

        <%# 5. Q&A (Help Desk) %>
        <% is_qa_active = controller_name == 'inquiries' %>
        <%= collapsible_sidebar_nav_item "Q&A", inquiries_path, :question, is_active: is_qa_active %>

        <%# 6. Contact Us %>
        <% is_about_active = current_page?(about_path) %>
        <%= collapsible_sidebar_nav_item "Contact Us", about_path, :info, is_active: is_about_active %>
      </div>

      <%# Boards Section %>
      <div class="pt-4 border-t border-stone-200/50">
        <%# 섹션 헤더 (펼친 상태에서만) %>
        <h3 class="px-3 text-xs font-bold text-stone-400 uppercase tracking-wider mb-2"
            data-sidebar-collapse-target="expandedContent">게시판</h3>

        <div class="space-y-0.5">
          <%# Popular %>
          <% is_popular_active = params[:sort] == 'popular' %>
          <%= collapsible_sidebar_nav_item "인기글", community_path(sort: :popular), :fire,
              is_active: is_popular_active %>

          <%# Free Board %>
          <% is_free_active = params[:category] == 'free' %>
          <%= collapsible_sidebar_nav_item "자유게시판", community_path(category: :free), :chat,
              is_active: is_free_active %>

          <%# Promotion %>
          <% is_promo_active = params[:category] == 'promotion' %>
          <%= collapsible_sidebar_nav_item "홍보", community_path(category: :promotion), :megaphone,
              is_active: is_promo_active %>
        </div>
      </div>

    </nav>

    <%# User Profile Widget (펼친 상태에서만) %>
    <div data-sidebar-collapse-target="expandedContent" class="w-full">
      <%= render "shared/sidebar_user_widget" %>
    </div>

    <%# 접힌 상태: 로그인 아이콘만 %>
    <div data-sidebar-collapse-target="collapsedContent" class="hidden p-2 border-t border-stone-100">
      <% if logged_in? %>
        <%= link_to profile_path(current_user), class: "flex justify-center p-2 hover:bg-stone-50 rounded-lg transition-colors" do %>
          <%= render_user_avatar(current_user, size: "sm") %>
        <% end %>
      <% else %>
        <%= link_to login_path, class: "flex justify-center p-2 hover:bg-stone-50 rounded-lg transition-colors", title: "로그인" do %>
          <svg class="w-6 h-6 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
        <% end %>
      <% end %>
    </div>
  </aside>
