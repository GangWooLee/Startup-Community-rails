<% content_for :page_title, "대시보드" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <span class="text-foreground font-medium">대시보드</span>
</nav>

<!-- 스코어카드 (Stat Cards) - 오늘 집중해야 할 지표 -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <!-- 총 회원수 -->
  <div class="bg-card rounded-xl border border-border p-5 card-hover">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-muted-foreground">총 회원</p>
        <p class="text-2xl font-bold text-foreground mt-1"><%= number_with_delimiter(@total_users) %></p>
        <p class="text-xs text-muted-foreground mt-1">
          <span class="text-green-600 font-medium">+<%= @today_users %></span> 오늘 가입
        </p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center">
        <%= icon "users", variant: :solid, css_class: "w-6 h-6 text-primary" %>
      </div>
    </div>
  </div>

  <!-- 처리 대기 신고 -->
  <%= link_to admin_reports_path(status: 'pending'), class: "bg-card rounded-xl border border-border p-5 card-hover block" do %>
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-muted-foreground">신고 대기</p>
        <p class="text-2xl font-bold text-foreground mt-1">
          <% if @pending_reports > 0 %>
            <span class="text-destructive"><%= @pending_reports %></span>
          <% else %>
            <span class="text-muted-foreground">0</span>
          <% end %>
        </p>
        <p class="text-xs mt-1">
          <% if @pending_reports > 0 %>
            <span class="text-destructive font-medium">처리 필요!</span>
          <% else %>
            <span class="text-green-600 font-medium">모두 처리됨</span>
          <% end %>
        </p>
      </div>
      <div class="w-12 h-12 rounded-xl <%= @pending_reports > 0 ? 'bg-destructive/10' : 'bg-muted' %> flex items-center justify-center">
        <%= icon "flag", variant: :solid, css_class: "w-6 h-6 #{@pending_reports > 0 ? 'text-destructive' : 'text-muted-foreground'}" %>
      </div>
    </div>
  <% end %>

  <!-- 현재 활성 사용자 -->
  <%= link_to active_admin_user_sessions_path, class: "bg-card rounded-xl border border-border p-5 card-hover block" do %>
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-muted-foreground">현재 접속자</p>
        <p class="text-2xl font-bold text-foreground mt-1">
          <% if @online_users_count > 0 %>
            <span class="text-green-600"><%= @online_users_count %></span>
          <% else %>
            <span class="text-muted-foreground">0</span>
          <% end %>
        </p>
        <p class="text-xs mt-1">
          <% if @online_users_count > 0 %>
            <span class="inline-flex items-center gap-1">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              <span class="text-green-600 font-medium"><%= @active_sessions_count %>개 세션 활성</span>
            </span>
          <% else %>
            <span class="text-muted-foreground">접속자 없음</span>
          <% end %>
        </p>
      </div>
      <div class="w-12 h-12 rounded-xl <%= @online_users_count > 0 ? 'bg-green-500/10' : 'bg-muted' %> flex items-center justify-center">
        <%= icon "signal", variant: :solid, css_class: "w-6 h-6 #{@online_users_count > 0 ? 'text-green-600' : 'text-muted-foreground'}" %>
      </div>
    </div>
  <% end %>

  <!-- 오늘 메시지 -->
  <div class="bg-card rounded-xl border border-border p-5 card-hover">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-muted-foreground">오늘 메시지</p>
        <p class="text-2xl font-bold text-foreground mt-1"><%= number_with_delimiter(@today_messages) %></p>
        <p class="text-xs text-muted-foreground mt-1">
          총 <%= number_with_delimiter(@total_messages) %>개
        </p>
      </div>
      <div class="w-12 h-12 rounded-xl bg-green-500/10 flex items-center justify-center">
        <%= icon "chat-bubble-left-right", variant: :solid, css_class: "w-6 h-6 text-green-600" %>
      </div>
    </div>
  </div>
</div>

<!-- 메인 콘텐츠 그리드 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- 왼쪽: 최근 가입 회원 (2/3) -->
  <div class="lg:col-span-2 space-y-6">
    <!-- 최근 가입 회원 -->
    <div class="bg-card rounded-xl border border-border overflow-hidden">
      <div class="px-5 py-4 border-b border-border flex items-center justify-between">
        <div>
          <h2 class="font-semibold text-foreground">최근 가입 회원</h2>
          <p class="text-sm text-muted-foreground">최근 7일 내 가입</p>
        </div>
        <%= link_to admin_users_path, class: "text-sm text-primary link-hover relative font-medium" do %>
          전체 보기 →
        <% end %>
      </div>

      <div class="divide-y divide-border">
        <% @recent_users.each do |user| %>
          <%= link_to admin_user_path(user), class: "flex items-center gap-4 px-5 py-3 card-hover" do %>
            <!-- 아바타 -->
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white font-medium flex-shrink-0">
              <%= user.name&.first&.upcase || "?" %>
            </div>

            <!-- 정보 -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <p class="font-medium text-foreground truncate"><%= user.name %></p>
                <% if user.admin? %>
                  <%= render_badge "관리자", variant: :destructive, class: "text-xs" %>
                <% elsif user.oauth_user? %>
                  <%= render_badge "OAuth", variant: :secondary, class: "text-xs" %>
                <% end %>
              </div>
              <p class="text-sm text-muted-foreground truncate"><%= user.email %></p>
            </div>

            <!-- 가입일 -->
            <div class="text-right flex-shrink-0">
              <p class="text-sm text-foreground"><%= user.created_at.strftime("%m/%d %H:%M") %></p>
              <p class="text-xs text-muted-foreground"><%= time_ago_in_words(user.created_at) %> 전</p>
            </div>
          <% end %>
        <% end %>
      </div>

      <% if @recent_users.empty? %>
        <div class="py-12 text-center">
          <%= icon "user-plus", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
          <p class="mt-2 text-sm text-muted-foreground">최근 가입한 회원이 없습니다</p>
        </div>
      <% end %>
    </div>

    <!-- 활성 채팅방 -->
    <div class="bg-card rounded-xl border border-border overflow-hidden">
      <div class="px-5 py-4 border-b border-border flex items-center justify-between">
        <div>
          <h2 class="font-semibold text-foreground">활성 채팅방</h2>
          <p class="text-sm text-muted-foreground">최근 메시지가 있는 채팅방</p>
        </div>
        <span class="text-sm text-muted-foreground">총 <%= @total_chat_rooms %>개</span>
      </div>

      <div class="divide-y divide-border">
        <% @recent_chat_rooms.each do |room| %>
          <%= link_to admin_chat_room_path(room), class: "flex items-center gap-4 px-5 py-3 card-hover" do %>
            <!-- 아이콘 -->
            <div class="w-10 h-10 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
              <%= icon "chat-bubble-left-right", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
            </div>

            <!-- 참여자 -->
            <div class="flex-1 min-w-0">
              <p class="font-medium text-foreground truncate">
                <%= room.users.map(&:name).join(" ↔ ") %>
              </p>
              <p class="text-sm text-muted-foreground">
                <%= room.messages.count %>개 메시지
              </p>
            </div>

            <!-- 마지막 활동 -->
            <div class="text-right flex-shrink-0">
              <% if room.last_message_at %>
                <p class="text-xs text-muted-foreground"><%= time_ago_in_words(room.last_message_at) %> 전</p>
              <% end %>
            </div>

            <!-- 열람 버튼 -->
            <%= render_badge "열람", variant: :secondary, class: "text-xs hover:bg-secondary" %>
          <% end %>
        <% end %>
      </div>

      <% if @recent_chat_rooms.empty? %>
        <div class="py-12 text-center">
          <%= icon "chat-bubble-left-right", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
          <p class="mt-2 text-sm text-muted-foreground">채팅방이 없습니다</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 오른쪽: 통계 요약 (1/3) -->
  <div class="space-y-6">
    <!-- 서비스 통계 -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-semibold text-foreground mb-4">서비스 통계</h3>

      <div class="space-y-4">
        <!-- 회원 -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
              <%= icon "users", variant: :solid, css_class: "w-4 h-4 text-primary" %>
            </div>
            <span class="text-sm text-muted-foreground">총 회원</span>
          </div>
          <span class="font-semibold text-foreground"><%= number_with_delimiter(@total_users) %></span>
        </div>

        <!-- 채팅방 -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center">
              <%= icon "chat-bubble-left-right", variant: :solid, css_class: "w-4 h-4 text-green-600" %>
            </div>
            <span class="text-sm text-muted-foreground">채팅방</span>
          </div>
          <span class="font-semibold text-foreground"><%= number_with_delimiter(@total_chat_rooms) %></span>
        </div>

        <!-- 메시지 -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center">
              <%= icon "chat-bubble-left", variant: :solid, css_class: "w-4 h-4 text-purple-600" %>
            </div>
            <span class="text-sm text-muted-foreground">메시지</span>
          </div>
          <span class="font-semibold text-foreground"><%= number_with_delimiter(@total_messages) %></span>
        </div>

        <!-- 게시글 -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center">
              <%= icon "document-text", variant: :solid, css_class: "w-4 h-4 text-orange-600" %>
            </div>
            <span class="text-sm text-muted-foreground">게시글</span>
          </div>
          <span class="font-semibold text-foreground"><%= number_with_delimiter(@total_posts) %></span>
        </div>

        <!-- 오늘 접속자 -->
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
              <%= icon "user-circle", variant: :solid, css_class: "w-4 h-4 text-blue-600" %>
            </div>
            <span class="text-sm text-muted-foreground">오늘 접속자</span>
          </div>
          <span class="font-semibold text-foreground"><%= number_with_delimiter(@unique_users_today) %></span>
        </div>
      </div>
    </div>

    <!-- 회원 분포 -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-semibold text-foreground mb-4">회원 분포</h3>

      <!-- 프로그레스 바 형태 분포 -->
      <div class="space-y-3">
        <% total = @total_users.to_f %>
        <% admin_count = @admin_users_count || 0 %>
        <% oauth_count = @oauth_users_count || 0 %>
        <% regular_count = total - admin_count - oauth_count %>

        <!-- 일반 회원 -->
        <div>
          <div class="flex items-center justify-between text-sm mb-1">
            <span class="text-muted-foreground">일반 회원</span>
            <span class="font-medium text-foreground"><%= regular_count.to_i %></span>
          </div>
          <div class="h-2 bg-muted rounded-full overflow-hidden">
            <div class="h-full bg-muted-foreground rounded-full transition-all" style="width: <%= total > 0 ? (regular_count / total * 100).round : 0 %>%"></div>
          </div>
        </div>

        <!-- OAuth -->
        <div>
          <div class="flex items-center justify-between text-sm mb-1">
            <span class="text-muted-foreground">OAuth 회원</span>
            <span class="font-medium text-foreground"><%= oauth_count %></span>
          </div>
          <div class="h-2 bg-muted rounded-full overflow-hidden">
            <div class="h-full bg-primary rounded-full transition-all" style="width: <%= total > 0 ? (oauth_count / total * 100).round : 0 %>%"></div>
          </div>
        </div>

        <!-- 관리자 -->
        <div>
          <div class="flex items-center justify-between text-sm mb-1">
            <span class="text-muted-foreground">관리자</span>
            <span class="font-medium text-foreground"><%= admin_count %></span>
          </div>
          <div class="h-2 bg-muted rounded-full overflow-hidden">
            <div class="h-full bg-destructive rounded-full transition-all" style="width: <%= total > 0 ? (admin_count / total * 100).round : 0 %>%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top 활동 회원 -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-semibold text-foreground mb-4">Top 활동 회원</h3>

      <div class="space-y-3">
        <% @top_active_users&.each_with_index do |user, index| %>
          <%= link_to admin_user_path(user), class: "flex items-center gap-3 card-hover rounded-lg p-1 -mx-1" do %>
            <!-- 순위 -->
            <span class="w-5 h-5 rounded-full <%= index < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-muted text-muted-foreground' %> text-xs font-bold flex items-center justify-center flex-shrink-0">
              <%= index + 1 %>
            </span>

            <!-- 아바타 -->
            <div class="w-8 h-8 rounded-full bg-muted flex items-center justify-center text-sm font-medium text-muted-foreground flex-shrink-0">
              <%= user.name&.first&.upcase || "?" %>
            </div>

            <!-- 이름 -->
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-foreground truncate"><%= user.name %></p>
            </div>

            <!-- 메시지 수 -->
            <span class="text-sm text-muted-foreground"><%= user.messages_count %> msg</span>
          <% end %>
        <% end %>
      </div>

      <% if @top_active_users.blank? %>
        <p class="text-sm text-muted-foreground text-center py-4">활동 데이터 없음</p>
      <% end %>
    </div>

    <!-- 빠른 액션 -->
    <div class="bg-card rounded-xl border border-border p-5">
      <h3 class="font-semibold text-foreground mb-4">빠른 액션</h3>

      <div class="space-y-2">
        <%= link_to admin_users_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg card-hover" do %>
          <%= icon "users", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
          <span class="text-sm text-foreground">회원 관리</span>
          <%= icon "chevron-right", variant: :mini, css_class: "w-4 h-4 text-muted-foreground/50 ml-auto" %>
        <% end %>

        <%= link_to admin_reports_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg card-hover" do %>
          <%= icon "flag", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
          <span class="text-sm text-foreground">신고 관리</span>
          <% if @pending_reports > 0 %>
            <span class="text-xs font-medium text-destructive ml-auto"><%= @pending_reports %> 대기</span>
          <% else %>
            <%= icon "chevron-right", variant: :mini, css_class: "w-4 h-4 text-muted-foreground/50 ml-auto" %>
          <% end %>
        <% end %>

        <%= link_to admin_inquiries_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg card-hover" do %>
          <%= icon "chat-bubble-left-right", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
          <span class="text-sm text-foreground">문의 관리</span>
          <% if @pending_inquiries > 0 %>
            <span class="text-xs font-medium text-yellow-600 ml-auto"><%= @pending_inquiries %> 대기</span>
          <% else %>
            <%= icon "chevron-right", variant: :mini, css_class: "w-4 h-4 text-muted-foreground/50 ml-auto" %>
          <% end %>
        <% end %>

        <%= link_to admin_user_sessions_path, class: "flex items-center gap-3 px-3 py-2 rounded-lg card-hover" do %>
          <%= icon "clock", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
          <span class="text-sm text-foreground">접속 기록</span>
          <% if @online_users_count > 0 %>
            <span class="inline-flex items-center gap-1 ml-auto">
              <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              <span class="text-xs font-medium text-green-600"><%= @online_users_count %> 온라인</span>
            </span>
          <% else %>
            <%= icon "chevron-right", variant: :mini, css_class: "w-4 h-4 text-muted-foreground/50 ml-auto" %>
          <% end %>
        <% end %>

        <a href="#" class="flex items-center gap-3 px-3 py-2 rounded-lg card-hover opacity-50 cursor-not-allowed">
          <%= icon "banknotes", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
          <span class="text-sm text-foreground">정산 관리</span>
          <span class="text-xs text-muted-foreground ml-auto">준비 중</span>
        </a>
      </div>
    </div>
  </div>
</div>
