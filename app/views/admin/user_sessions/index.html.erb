<% content_for :page_title, "접속 기록" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <span class="text-foreground font-medium">접속 기록</span>
</nav>

<!-- 상단 통계 -->
<div class="grid grid-cols-4 gap-4 mb-6">
  <!-- 현재 활성 세션 -->
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
        <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@active_count || 0) %></p>
        <p class="text-xs text-muted-foreground">활성 세션</p>
      </div>
    </div>
  </div>

  <!-- 현재 접속 중인 사용자 -->
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
        <%= icon "users", variant: :solid, css_class: "w-5 h-5 text-blue-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@online_users_count || 0) %></p>
        <p class="text-xs text-muted-foreground">온라인 사용자</p>
      </div>
    </div>
  </div>

  <!-- 오늘 로그인 수 -->
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
        <%= icon "arrow-right-on-rectangle", variant: :solid, css_class: "w-5 h-5 text-purple-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@today_logins || 0) %></p>
        <p class="text-xs text-muted-foreground">오늘 로그인</p>
      </div>
    </div>
  </div>

  <!-- 오늘 고유 사용자 -->
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
        <%= icon "user", variant: :solid, css_class: "w-5 h-5 text-amber-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@unique_users_today || 0) %></p>
        <p class="text-xs text-muted-foreground">오늘 접속 사용자</p>
      </div>
    </div>
  </div>
</div>

<!-- 검색 및 필터 -->
<div class="bg-card rounded-xl border border-border p-4 mb-6">
  <div class="flex items-center gap-4">
    <!-- 검색 -->
    <%= form_with url: admin_user_sessions_path, method: :get, local: true, class: "flex-1", data: { turbo: false } do %>
      <div class="relative">
        <%= icon "magnifying-glass", variant: :outline, css_class: "absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" %>
        <input type="text"
               name="q"
               value="<%= params[:q] %>"
               placeholder="이메일 또는 이름으로 검색..."
               class="w-full pl-10 pr-4 py-2.5 bg-muted border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary focus:bg-background transition">
      </div>
    <% end %>

    <!-- 상태 필터 탭 -->
    <div class="flex items-center gap-2 border-l border-border pl-4">
      <%= link_to admin_user_sessions_path(method: params[:method]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:status].blank? ? 'bg-foreground text-background' : 'bg-muted text-muted-foreground'}" do %>
        전체
      <% end %>
      <%= link_to admin_user_sessions_path(status: 'active', method: params[:method]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:status] == 'active' ? 'bg-green-600 text-white' : 'bg-muted text-muted-foreground'}" do %>
        <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-1"></span>
        활성
      <% end %>
      <%= link_to admin_user_sessions_path(status: 'ended', method: params[:method]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:status] == 'ended' ? 'bg-gray-600 text-white' : 'bg-muted text-muted-foreground'}" do %>
        종료됨
      <% end %>
    </div>

    <!-- 로그인 방식 필터 -->
    <div class="flex items-center gap-2 border-l border-border pl-4">
      <%= link_to admin_user_sessions_path(status: params[:status]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:method].blank? ? 'bg-foreground/80 text-background' : 'bg-muted text-muted-foreground'}" do %>
        전체
      <% end %>
      <%= link_to admin_user_sessions_path(method: 'email', status: params[:status]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:method] == 'email' ? 'bg-blue-600 text-white' : 'bg-muted text-muted-foreground'}" do %>
        이메일
      <% end %>
      <%= link_to admin_user_sessions_path(method: 'google', status: params[:status]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:method] == 'google' ? 'bg-red-500 text-white' : 'bg-muted text-muted-foreground'}" do %>
        Google
      <% end %>
      <%= link_to admin_user_sessions_path(method: 'github', status: params[:status]),
                  class: "px-3 py-2 rounded-lg text-sm font-medium btn-hover #{params[:method] == 'github' ? 'bg-gray-800 text-white' : 'bg-muted text-muted-foreground'}" do %>
        GitHub
      <% end %>
    </div>

    <!-- CSV 내보내기 버튼 -->
    <div class="border-l border-border pl-4">
      <%= link_to export_admin_user_sessions_path(status: params[:status], method: params[:method], q: params[:q], from_date: params[:from_date], to_date: params[:to_date], format: :csv),
                  class: "inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium btn-hover" do %>
        <%= icon "arrow-down-tray", variant: :outline, css_class: "w-4 h-4" %>
        CSV
      <% end %>
    </div>
  </div>

  <!-- 날짜 범위 필터 -->
  <div class="mt-4 pt-4 border-t border-border">
    <%= form_with url: admin_user_sessions_path, method: :get, local: true, data: { turbo: false }, class: "flex items-center gap-3" do %>
      <!-- 기존 필터 유지 -->
      <input type="hidden" name="status" value="<%= params[:status] %>">
      <input type="hidden" name="method" value="<%= params[:method] %>">
      <input type="hidden" name="q" value="<%= params[:q] %>">

      <span class="text-sm text-muted-foreground">기간:</span>
      <input type="date"
             name="from_date"
             value="<%= params[:from_date] %>"
             class="px-3 py-2 bg-muted border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
      <span class="text-muted-foreground">~</span>
      <input type="date"
             name="to_date"
             value="<%= params[:to_date] %>"
             class="px-3 py-2 bg-muted border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
      <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium btn-hover">
        적용
      </button>
      <% if params[:from_date].present? || params[:to_date].present? %>
        <%= link_to admin_user_sessions_path(status: params[:status], method: params[:method], q: params[:q]),
                    class: "px-3 py-2 text-sm text-muted-foreground link-hover" do %>
          날짜 초기화
        <% end %>
      <% end %>
    <% end %>
  </div>

  <% if params[:q].present? %>
    <div class="mt-3 flex items-center gap-2">
      <span class="text-sm text-muted-foreground">
        "<span class="font-medium text-foreground"><%= params[:q] %></span>" 검색 결과:
        <span class="font-bold text-primary"><%= @total_count %></span>개
      </span>
      <%= link_to admin_user_sessions_path, class: "text-sm text-muted-foreground link-hover relative underline" do %>
        초기화
      <% end %>
    </div>
  <% end %>
</div>

<!-- 세션 목록 테이블 -->
<div class="bg-card rounded-xl border border-border overflow-hidden">
  <table class="w-full">
    <thead>
      <tr class="bg-muted border-b border-border">
        <th class="px-5 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">사용자</th>
        <th class="px-5 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">로그인 방식</th>
        <th class="px-5 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">디바이스</th>
        <th class="px-5 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">로그인 시간</th>
        <th class="px-5 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">상태</th>
        <th class="px-5 py-3 text-right text-xs font-semibold text-muted-foreground uppercase tracking-wider">액션</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-border">
      <% @sessions.each do |session| %>
        <tr class="<%= session.active? ? '' : 'bg-muted/50' %> card-hover">
          <!-- 사용자 정보 -->
          <td class="px-5 py-4">
            <% if session.user %>
              <%= link_to admin_user_path(session.user), class: "flex items-center gap-3" do %>
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-white font-medium flex-shrink-0">
                  <%= session.user.name&.first&.upcase || "?" %>
                </div>
                <div class="min-w-0">
                  <p class="font-medium text-foreground truncate"><%= session.user.name %></p>
                  <p class="text-sm text-muted-foreground truncate"><%= session.user.email %></p>
                </div>
              <% end %>
            <% else %>
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-medium flex-shrink-0">?</div>
                <div>
                  <p class="font-medium text-muted-foreground">탈퇴 회원</p>
                </div>
              </div>
            <% end %>
          </td>

          <!-- 로그인 방식 -->
          <td class="px-5 py-4">
            <% case session.login_method %>
            <% when "email" %>
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                <%= icon "envelope", variant: :solid, css_class: "w-3.5 h-3.5 mr-1" %>
                이메일
              </span>
            <% when "google" %>
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
                <svg class="w-3.5 h-3.5 mr-1" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Google
              </span>
            <% when "github" %>
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-800 text-white">
                <svg class="w-3.5 h-3.5 mr-1" viewBox="0 0 24 24"><path fill="currentColor" d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                GitHub
              </span>
            <% end %>
          </td>

          <!-- 디바이스 -->
          <td class="px-5 py-4">
            <div class="flex items-center gap-2 text-sm">
              <% case session.device_type %>
              <% when "mobile" %>
                <%= icon "device-phone-mobile", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
                <span class="text-muted-foreground">모바일</span>
              <% when "tablet" %>
                <%= icon "device-tablet", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
                <span class="text-muted-foreground">태블릿</span>
              <% else %>
                <%= icon "computer-desktop", variant: :outline, css_class: "w-5 h-5 text-muted-foreground" %>
                <span class="text-muted-foreground">데스크톱</span>
              <% end %>
            </div>
            <p class="text-xs text-muted-foreground mt-1" title="<%= session.ip_address %>">
              IP: <%= session.masked_ip_address %>
            </p>
          </td>

          <!-- 로그인 시간 -->
          <td class="px-5 py-4">
            <p class="text-sm text-foreground"><%= session.logged_in_at.strftime("%Y-%m-%d %H:%M") %></p>
            <p class="text-xs text-muted-foreground"><%= time_ago_in_words(session.logged_in_at) %> 전</p>
          </td>

          <!-- 상태 -->
          <td class="px-5 py-4">
            <% if session.active? %>
              <span class="inline-flex items-center gap-1.5 text-sm">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-green-600 font-medium">활성</span>
              </span>
              <% if session.remember_me %>
                <span class="block text-xs text-muted-foreground mt-1">Remember Me</span>
              <% end %>
            <% else %>
              <span class="inline-flex items-center gap-1.5 text-sm">
                <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                <span class="text-muted-foreground">종료됨</span>
              </span>
              <p class="text-xs text-muted-foreground mt-1">
                <%= logout_reason_label(session.logout_reason) %>
              </p>
              <p class="text-xs text-muted-foreground">
                <%= session.duration_formatted %>
              </p>
            <% end %>
          </td>

          <!-- 액션 -->
          <td class="px-5 py-4 text-right">
            <div class="flex items-center justify-end gap-1">
              <% if session.user %>
                <%= link_to admin_user_path(session.user),
                            class: "p-2 text-muted-foreground rounded-lg btn-hover",
                            title: "사용자 상세" do %>
                  <%= icon "user", variant: :outline, css_class: "w-5 h-5" %>
                <% end %>
              <% end %>
              <% if session.active? %>
                <%= button_to force_logout_admin_user_session_path(session),
                              method: :post,
                              class: "p-2 text-destructive rounded-lg btn-hover",
                              title: "강제 로그아웃",
                              data: { turbo_confirm: "#{session.user&.name || '이 사용자'}의 세션을 강제 종료하시겠습니까?" } do %>
                  <%= icon "arrow-right-on-rectangle", variant: :outline, css_class: "w-5 h-5" %>
                <% end %>
              <% end %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @sessions.empty? %>
    <div class="py-12 text-center">
      <%= icon "clock", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
      <h3 class="mt-2 text-sm font-medium text-foreground">세션 기록 없음</h3>
      <p class="mt-1 text-sm text-muted-foreground">검색 결과가 없습니다.</p>
    </div>
  <% end %>
</div>

<!-- 페이지네이션 -->
<% if @total_pages && @total_pages > 1 %>
  <% filter_params = { q: params[:q], method: params[:method], status: params[:status], from_date: params[:from_date], to_date: params[:to_date] }.compact %>

  <div class="mt-6 flex items-center justify-between">
    <p class="text-sm text-muted-foreground">
      총 <span class="font-medium text-foreground"><%= @total_count %></span>개 중
      <span class="font-medium text-foreground"><%= (@page - 1) * @per_page + 1 %>-<%= [(@page * @per_page), @total_count].min %></span>개 표시
    </p>

    <nav class="flex items-center gap-1">
      <% if @page > 1 %>
        <%= link_to admin_user_sessions_path(filter_params.merge(page: @page - 1)),
                    class: "p-2 rounded-lg border border-border text-muted-foreground btn-hover" do %>
          <%= icon "chevron-left", variant: :mini, css_class: "w-5 h-5" %>
        <% end %>
      <% end %>

      <% visible_pages = ([@page - 2, 1].max..[@page + 2, @total_pages].min) %>
      <% visible_pages.each do |page_num| %>
        <% if page_num == @page %>
          <span class="px-4 py-2 rounded-lg bg-foreground text-background text-sm font-medium"><%= page_num %></span>
        <% else %>
          <%= link_to page_num, admin_user_sessions_path(filter_params.merge(page: page_num)),
                      class: "px-4 py-2 rounded-lg border border-border text-muted-foreground text-sm btn-hover" %>
        <% end %>
      <% end %>

      <% if @page < @total_pages %>
        <%= link_to admin_user_sessions_path(filter_params.merge(page: @page + 1)),
                    class: "p-2 rounded-lg border border-border text-muted-foreground btn-hover" do %>
          <%= icon "chevron-right", variant: :mini, css_class: "w-5 h-5" %>
        <% end %>
      <% end %>
    </nav>
  </div>
<% end %>
