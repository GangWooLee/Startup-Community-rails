<% content_for :page_title, "AI 분석 관리" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <span class="text-foreground font-medium">AI 분석 관리</span>
</nav>

<!-- 상단 통계 -->
<div class="grid grid-cols-4 gap-4 mb-6">
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
        <%= icon "sparkles", variant: :solid, css_class: "w-5 h-5 text-primary" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@total_analyses) %></p>
        <p class="text-xs text-muted-foreground">총 분석</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
        <%= icon "clock", variant: :solid, css_class: "w-5 h-5 text-green-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @today_analyses %></p>
        <p class="text-xs text-muted-foreground">오늘 분석</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
        <%= icon "beaker", variant: :solid, css_class: "w-5 h-5 text-purple-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @real_analyses %>/<%= @mock_analyses %></p>
        <p class="text-xs text-muted-foreground">실제/Mock</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
        <%= icon "chart-bar", variant: :solid, css_class: "w-5 h-5 text-amber-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @avg_analyses %></p>
        <p class="text-xs text-muted-foreground">평균 사용량</p>
      </div>
    </div>
  </div>
</div>

<!-- 상태별 통계 -->
<div class="grid grid-cols-3 gap-4 mb-6">
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">완료</span>
      <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-600 text-xs font-medium"><%= @completed_count %></span>
    </div>
  </div>
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">분석 중</span>
      <span class="px-2 py-1 rounded-full bg-blue-500/10 text-blue-600 text-xs font-medium"><%= @analyzing_count %></span>
    </div>
  </div>
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">실패</span>
      <span class="px-2 py-1 rounded-full bg-red-500/10 text-red-600 text-xs font-medium"><%= @failed_count %></span>
    </div>
  </div>
</div>

<!-- 검색 -->
<div class="bg-card rounded-xl border border-border p-4 mb-6">
  <div class="flex items-center gap-4">
    <%= form_with url: admin_ai_usages_path, method: :get, data: { turbo: false }, class: "flex-1 flex items-center gap-3" do |f| %>
      <div class="relative flex-1">
        <%= icon "magnifying-glass", variant: :outline, css_class: "w-4 h-4 text-muted-foreground absolute left-3 top-1/2 -translate-y-1/2" %>
        <%= f.text_field :q,
            value: params[:q],
            placeholder: "이메일 또는 이름으로 검색...",
            class: "w-full pl-10 pr-4 py-2 bg-background border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent" %>
      </div>
      <%= f.submit "검색", class: "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium btn-hover cursor-pointer" %>
      <% if params[:q].present? %>
        <%= link_to admin_ai_usages_path, class: "px-4 py-2 bg-secondary text-secondary-foreground rounded-lg text-sm font-medium btn-hover" do %>
          초기화
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>

<!-- 사용자 목록 -->
<div class="bg-card rounded-xl border border-border overflow-hidden">
  <div class="p-4 border-b border-border">
    <h2 class="font-semibold text-foreground">
      <%= params[:q].present? ? "검색 결과" : "Top 사용자" %>
      <span class="text-muted-foreground font-normal ml-2">(<%= @users.size %>명)</span>
    </h2>
  </div>

  <% if @users.any? %>
    <table class="w-full">
      <thead class="bg-muted/50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">사용자</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">분석 횟수</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">Limit</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">보너스</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">잔여</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">상태</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">액션</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border">
        <% @users.each do |user| %>
          <% stats = user.ai_usage_stats %>
          <tr class="hover:bg-muted/30 transition-colors">
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                  <span class="text-xs font-medium text-primary"><%= user.name[0].upcase %></span>
                </div>
                <div>
                  <p class="text-sm font-medium text-foreground"><%= user.name %></p>
                  <p class="text-xs text-muted-foreground"><%= user.email %></p>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm font-medium text-foreground"><%= stats[:used] %></span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:is_custom_limit] ? 'text-purple-600 font-medium' : 'text-muted-foreground' %>">
                <%= stats[:limit] %>
                <% if stats[:is_custom_limit] %>
                  <span class="text-xs">(커스텀)</span>
                <% end %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:has_bonus] ? 'text-yellow-600 font-medium' : 'text-muted-foreground' %>">
                +<%= stats[:bonus] %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:remaining] == 0 ? 'text-red-600' : 'text-foreground' %>">
                <%= stats[:remaining] %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <% if stats[:reached] %>
                <span class="px-2 py-1 rounded-full bg-red-500/10 text-red-600 text-xs font-medium">Limit 도달</span>
              <% else %>
                <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-600 text-xs font-medium">정상</span>
              <% end %>
            </td>
            <td class="px-4 py-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <%= link_to admin_ai_usage_path(user), class: "px-3 py-1.5 bg-primary/10 text-primary rounded-lg text-xs font-medium btn-hover" do %>
                  상세
                <% end %>
                <%= button_to reset_admin_ai_usage_path(user),
                    method: :delete,
                    data: { confirm: "#{user.name}의 모든 분석 기록을 삭제하시겠습니까?" },
                    class: "px-3 py-1.5 bg-red-500/10 text-red-600 rounded-lg text-xs font-medium btn-hover" do %>
                  리셋
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="p-8 text-center">
      <%= icon "magnifying-glass", variant: :outline, css_class: "w-12 h-12 text-muted-foreground mx-auto mb-3" %>
      <p class="text-muted-foreground">검색 결과가 없습니다.</p>
    </div>
  <% end %>
</div>
