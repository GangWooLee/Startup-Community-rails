<% content_for :page_title, "AI 분석 관리" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <span class="text-foreground font-medium">AI 분석 관리</span>
</nav>

<%# 필터 파라미터 (탭 전환 시 유지) %>
<% filter_params = { q: params[:q], from_date: params[:from_date], to_date: params[:to_date] }.compact %>

<!-- 상단 통계 -->
<div class="grid grid-cols-4 gap-4 mb-6">
  <div class="bg-card rounded-xl border border-border p-4 card-hover relative">
    <% if @has_date_filter %>
      <span class="absolute top-2 right-2 w-2 h-2 rounded-full bg-primary" title="날짜 필터 적용됨"></span>
    <% end %>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
        <%= icon "sparkles", variant: :solid, css_class: "w-5 h-5 text-primary" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@total_analyses) %></p>
        <p class="text-xs text-muted-foreground"><%= @has_date_filter ? "필터된 분석" : "총 분석" %></p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
        <%= icon "clock", variant: :solid, css_class: "w-5 h-5 text-green-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @today_analyses %></p>
        <p class="text-xs text-muted-foreground">오늘 분석</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center">
        <%= icon "beaker", variant: :solid, css_class: "w-5 h-5 text-purple-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @real_analyses %>/<%= @mock_analyses %></p>
        <p class="text-xs text-muted-foreground">실제/Mock</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
        <%= icon "chart-bar", variant: :solid, css_class: "w-5 h-5 text-amber-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @avg_analyses %></p>
        <p class="text-xs text-muted-foreground">평균 사용량</p>
      </div>
    </div>
  </div>
</div>

<!-- 상태별 통계 -->
<div class="grid grid-cols-3 gap-4 mb-6">
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">완료</span>
      <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-600 text-xs font-medium"><%= @completed_count %></span>
    </div>
  </div>
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">분석 중</span>
      <span class="px-2 py-1 rounded-full bg-blue-500/10 text-blue-600 text-xs font-medium"><%= @analyzing_count %></span>
    </div>
  </div>
  <div class="bg-card rounded-xl border border-border p-4">
    <div class="flex items-center justify-between">
      <span class="text-sm text-muted-foreground">실패</span>
      <span class="px-2 py-1 rounded-full bg-red-500/10 text-red-600 text-xs font-medium"><%= @failed_count %></span>
    </div>
  </div>
</div>

<!-- 영구 보존 사용 기록 (삭제된 분석 포함) -->
<% if @permanent_stats.present? %>
<div class="bg-card rounded-xl border border-border p-4 mb-6">
  <div class="flex items-center gap-2 mb-3">
    <%= icon "archive-box", variant: :solid, css_class: "w-5 h-5 text-primary" %>
    <h3 class="font-semibold text-foreground">영구 보존 사용 기록</h3>
    <span class="text-xs text-muted-foreground">(삭제된 분석 포함)</span>
  </div>
  <div class="grid grid-cols-5 gap-4">
    <div>
      <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@permanent_stats[:total]) %></p>
      <p class="text-xs text-muted-foreground">누적 분석</p>
    </div>
    <div>
      <p class="text-2xl font-bold text-amber-600"><%= number_with_delimiter(@deleted_analyses_count) %></p>
      <p class="text-xs text-muted-foreground">삭제된 분석</p>
    </div>
    <div>
      <p class="text-2xl font-bold text-green-600"><%= number_with_delimiter(@saved_by_user_count) %></p>
      <p class="text-xs text-muted-foreground">사용자 저장</p>
    </div>
    <div>
      <p class="text-2xl font-bold text-foreground"><%= number_with_delimiter(@permanent_stats[:this_month]) %></p>
      <p class="text-xs text-muted-foreground">이번 달</p>
    </div>
    <div>
      <% save_rate = @permanent_stats[:total] > 0 ? (@saved_by_user_count.to_f / @permanent_stats[:total] * 100).round(1) : 0 %>
      <p class="text-2xl font-bold <%= save_rate >= 50 ? 'text-green-600' : 'text-amber-600' %>"><%= save_rate %>%</p>
      <p class="text-xs text-muted-foreground">저장율</p>
    </div>
  </div>
</div>
<% end %>

<!-- 검색 및 필터 -->
<div class="bg-card rounded-xl border border-border p-4 mb-6">
  <div class="flex items-center gap-4">
    <%= form_with url: admin_ai_usages_path, method: :get, data: { turbo: false }, class: "flex-1 flex items-center gap-3" do |f| %>
      <!-- 기존 필터 유지 -->
      <input type="hidden" name="from_date" value="<%= params[:from_date] %>">
      <input type="hidden" name="to_date" value="<%= params[:to_date] %>">
      <input type="hidden" name="view" value="<%= params[:view] %>">

      <div class="relative flex-1">
        <%= icon "magnifying-glass", variant: :outline, css_class: "w-4 h-4 text-muted-foreground absolute left-3 top-1/2 -translate-y-1/2" %>
        <%= f.text_field :q,
            value: params[:q],
            placeholder: "이메일 또는 이름으로 검색...",
            class: "w-full pl-10 pr-4 py-2 bg-background border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent" %>
      </div>
      <%= f.submit "검색", class: "px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium btn-hover cursor-pointer" %>
      <% if params[:q].present? %>
        <%= link_to admin_ai_usages_path(from_date: params[:from_date], to_date: params[:to_date], view: params[:view]), class: "px-4 py-2 bg-secondary text-secondary-foreground rounded-lg text-sm font-medium btn-hover" do %>
          초기화
        <% end %>
      <% end %>
    <% end %>

    <!-- CSV 내보내기 버튼 -->
    <div class="border-l border-border pl-4">
      <%= link_to export_admin_ai_usages_path(**filter_params, format: :csv),
                  class: "inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium btn-hover" do %>
        <%= icon "arrow-down-tray", variant: :outline, css_class: "w-4 h-4" %>
        CSV 다운로드
      <% end %>
    </div>
  </div>

  <!-- 날짜 범위 필터 -->
  <div class="mt-4 pt-4 border-t border-border">
    <%= form_with url: admin_ai_usages_path, method: :get, data: { turbo: false }, class: "flex items-center gap-3" do %>
      <!-- 기존 필터 유지 -->
      <input type="hidden" name="q" value="<%= params[:q] %>">
      <input type="hidden" name="view" value="<%= params[:view] %>">

      <span class="text-sm text-muted-foreground">분석일:</span>
      <input type="date"
             name="from_date"
             value="<%= params[:from_date] %>"
             class="px-3 py-2 bg-muted border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
      <span class="text-muted-foreground">~</span>
      <input type="date"
             name="to_date"
             value="<%= params[:to_date] %>"
             class="px-3 py-2 bg-muted border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-primary">
      <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium btn-hover">
        적용
      </button>
      <% if params[:from_date].present? || params[:to_date].present? %>
        <%= link_to admin_ai_usages_path(q: params[:q], view: params[:view]),
                    class: "px-3 py-2 text-sm text-muted-foreground link-hover" do %>
          날짜 초기화
        <% end %>
        <span class="ml-2 text-sm text-primary font-medium">
          (필터된 분석: <%= number_with_delimiter(@total_analyses) %>개)
        </span>
      <% end %>
    <% end %>
  </div>
</div>

<!-- 탭 네비게이션 -->
<div class="flex items-center gap-2 mb-6">
  <%= link_to admin_ai_usages_path(**filter_params),
              class: "px-4 py-2 rounded-lg text-sm font-medium transition-colors #{@current_view != 'history' ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground hover:bg-muted/80'}" do %>
    <%= icon "users", variant: :outline, css_class: "w-4 h-4 inline-block mr-1.5" %>
    Top 사용자
  <% end %>
  <%= link_to admin_ai_usages_path(view: 'history', **filter_params),
              class: "px-4 py-2 rounded-lg text-sm font-medium transition-colors #{@current_view == 'history' ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground hover:bg-muted/80'}" do %>
    <%= icon "clock", variant: :outline, css_class: "w-4 h-4 inline-block mr-1.5" %>
    사용 이력
  <% end %>
</div>

<% if @current_view == 'history' %>
  <!-- 사용 이력 테이블 -->
  <div class="bg-card rounded-xl border border-border overflow-hidden">
    <div class="p-4 border-b border-border flex items-center justify-between">
      <h2 class="font-semibold text-foreground">
        사용 이력
        <span class="text-muted-foreground font-normal ml-2">(<%= number_with_delimiter(@total_count) %>건)</span>
      </h2>
      <% if @total_pages > 1 %>
        <span class="text-sm text-muted-foreground">
          페이지 <%= @page %> / <%= @total_pages %>
        </span>
      <% end %>
    </div>

    <% if @analyses.any? %>
      <table class="w-full">
        <thead class="bg-muted/50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">사용자</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">아이디어</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">분석 일시</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">상태</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">저장</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">점수</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">액션</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <% @analyses.each do |analysis| %>
            <tr class="hover:bg-muted/30 transition-colors">
              <td class="px-4 py-3">
                <% if analysis.user %>
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                      <span class="text-xs font-medium text-primary"><%= analysis.user.name[0].upcase %></span>
                    </div>
                    <div>
                      <p class="text-sm font-medium text-foreground"><%= analysis.user.name %></p>
                      <p class="text-xs text-muted-foreground"><%= analysis.user.email %></p>
                    </div>
                  </div>
                <% else %>
                  <span class="text-sm text-muted-foreground">(삭제된 사용자)</span>
                <% end %>
              </td>
              <td class="px-4 py-3">
                <p class="text-sm text-foreground line-clamp-2 max-w-xs" title="<%= analysis.idea %>">
                  <%= analysis.idea.to_s.truncate(80) %>
                </p>
              </td>
              <td class="px-4 py-3 text-center">
                <div class="text-sm text-foreground"><%= analysis.created_at.strftime("%Y-%m-%d %H:%M") %></div>
                <div class="text-xs text-muted-foreground"><%= time_ago_in_words(analysis.created_at) %> 전</div>
              </td>
              <td class="px-4 py-3 text-center">
                <% case analysis.status %>
                <% when "completed" %>
                  <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-600 text-xs font-medium">완료</span>
                <% when "analyzing" %>
                  <span class="px-2 py-1 rounded-full bg-blue-500/10 text-blue-600 text-xs font-medium">분석 중</span>
                <% when "pending" %>
                  <span class="px-2 py-1 rounded-full bg-gray-500/10 text-gray-600 text-xs font-medium">대기</span>
                <% when "failed" %>
                  <span class="px-2 py-1 rounded-full bg-red-500/10 text-red-600 text-xs font-medium">실패</span>
                <% else %>
                  <span class="px-2 py-1 rounded-full bg-gray-500/10 text-gray-600 text-xs font-medium"><%= analysis.status %></span>
                <% end %>
              </td>
              <td class="px-4 py-3 text-center">
                <% if analysis.is_saved %>
                  <%= icon "check-circle", variant: :solid, css_class: "w-5 h-5 text-green-600 mx-auto" %>
                <% else %>
                  <%= icon "minus-circle", variant: :outline, css_class: "w-5 h-5 text-muted-foreground mx-auto" %>
                <% end %>
              </td>
              <td class="px-4 py-3 text-center">
                <% if analysis.score.present? %>
                  <span class="text-sm font-medium <%= analysis.score >= 70 ? 'text-green-600' : analysis.score >= 40 ? 'text-amber-600' : 'text-red-600' %>">
                    <%= analysis.score %>
                  </span>
                <% else %>
                  <span class="text-sm text-muted-foreground">-</span>
                <% end %>
              </td>
              <td class="px-4 py-3 text-right">
                <% if analysis.user %>
                  <%= link_to admin_ai_usage_path(analysis.user), class: "px-3 py-1.5 bg-primary/10 text-primary rounded-lg text-xs font-medium btn-hover" do %>
                    상세
                  <% end %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <!-- 페이지네이션 -->
      <% if @total_pages > 1 %>
        <div class="p-4 border-t border-border flex items-center justify-center gap-2">
          <% if @page > 1 %>
            <%= link_to admin_ai_usages_path(page: @page - 1, view: 'history', **filter_params),
                        class: "px-3 py-1.5 bg-muted text-muted-foreground rounded-lg text-sm btn-hover" do %>
              <%= icon "chevron-left", variant: :outline, css_class: "w-4 h-4" %>
            <% end %>
          <% end %>

          <% # 페이지 번호 (최대 7개 표시) %>
          <% start_page = [1, @page - 3].max %>
          <% end_page = [start_page + 6, @total_pages].min %>
          <% start_page = [1, end_page - 6].max %>

          <% (start_page..end_page).each do |p| %>
            <%= link_to admin_ai_usages_path(page: p, view: 'history', **filter_params),
                        class: "px-3 py-1.5 rounded-lg text-sm #{p == @page ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground btn-hover'}" do %>
              <%= p %>
            <% end %>
          <% end %>

          <% if @page < @total_pages %>
            <%= link_to admin_ai_usages_path(page: @page + 1, view: 'history', **filter_params),
                        class: "px-3 py-1.5 bg-muted text-muted-foreground rounded-lg text-sm btn-hover" do %>
              <%= icon "chevron-right", variant: :outline, css_class: "w-4 h-4" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <div class="p-8 text-center">
        <%= icon "clock", variant: :outline, css_class: "w-12 h-12 text-muted-foreground mx-auto mb-3" %>
        <p class="text-muted-foreground">사용 이력이 없습니다.</p>
      </div>
    <% end %>
  </div>

<% else %>
  <!-- 사용자 목록 -->
<div class="bg-card rounded-xl border border-border overflow-hidden">
  <div class="p-4 border-b border-border">
    <h2 class="font-semibold text-foreground">
      <%= params[:q].present? ? "검색 결과" : "Top 사용자" %>
      <span class="text-muted-foreground font-normal ml-2">(<%= @users.size %>명)</span>
    </h2>
  </div>

  <% if @users.any? %>
    <table class="w-full">
      <thead class="bg-muted/50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase">사용자</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">분석 횟수</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">Limit</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">보너스</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">잔여</th>
          <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase">상태</th>
          <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase">액션</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border">
        <% @users.each do |user| %>
          <% stats = user.ai_usage_stats %>
          <tr class="hover:bg-muted/30 transition-colors">
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                  <span class="text-xs font-medium text-primary"><%= user.name[0].upcase %></span>
                </div>
                <div>
                  <p class="text-sm font-medium text-foreground"><%= user.name %></p>
                  <p class="text-xs text-muted-foreground"><%= user.email %></p>
                </div>
              </div>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm font-medium text-foreground"><%= stats[:used] %></span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:is_custom_limit] ? 'text-purple-600 font-medium' : 'text-muted-foreground' %>">
                <%= stats[:limit] %>
                <% if stats[:is_custom_limit] %>
                  <span class="text-xs">(커스텀)</span>
                <% end %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:has_bonus] ? 'text-yellow-600 font-medium' : 'text-muted-foreground' %>">
                +<%= stats[:bonus] %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <span class="text-sm <%= stats[:remaining] == 0 ? 'text-red-600' : 'text-foreground' %>">
                <%= stats[:remaining] %>
              </span>
            </td>
            <td class="px-4 py-3 text-center">
              <% if stats[:reached] %>
                <span class="px-2 py-1 rounded-full bg-red-500/10 text-red-600 text-xs font-medium">Limit 도달</span>
              <% else %>
                <span class="px-2 py-1 rounded-full bg-green-500/10 text-green-600 text-xs font-medium">정상</span>
              <% end %>
            </td>
            <td class="px-4 py-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <%= link_to admin_ai_usage_path(user), class: "px-3 py-1.5 bg-primary/10 text-primary rounded-lg text-xs font-medium btn-hover" do %>
                  상세
                <% end %>
                <%= button_to reset_admin_ai_usage_path(user),
                    method: :delete,
                    data: { confirm: "#{user.name}의 모든 분석 기록을 삭제하시겠습니까?" },
                    class: "px-3 py-1.5 bg-red-500/10 text-red-600 rounded-lg text-xs font-medium btn-hover" do %>
                  리셋
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <div class="p-8 text-center">
      <%= icon "magnifying-glass", variant: :outline, css_class: "w-12 h-12 text-muted-foreground mx-auto mb-3" %>
      <p class="text-muted-foreground">검색 결과가 없습니다.</p>
    </div>
  <% end %>
</div>
<% end %>
