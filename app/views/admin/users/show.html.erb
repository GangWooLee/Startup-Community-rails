<% content_for :page_title, "회원 상세" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <%= link_to "회원 관리", admin_users_path, class: "link-hover relative" %>
  <span>/</span>
  <span class="text-foreground font-medium"><%= @user.name %></span>
</nav>

<div class="flex gap-6">
  <!-- 왼쪽: 프로필 카드 (고정 너비) -->
  <div class="w-80 flex-shrink-0">
    <div class="bg-card rounded-xl border border-border overflow-hidden sticky top-6">
      <!-- 프로필 헤더 -->
      <div class="bg-gradient-to-br from-blue-500 to-purple-600 px-6 py-8 text-center">
        <div class="w-20 h-20 mx-auto rounded-full bg-card/20 backdrop-blur flex items-center justify-center text-white text-2xl font-bold border-4 border-white/30">
          <%= @user.name&.first&.upcase || "?" %>
        </div>
        <h2 class="text-xl font-bold text-white mt-4"><%= @user.name %></h2>
        <p class="text-sm text-white/80 mt-1"><%= @user.email %></p>

        <!-- 상태 뱃지 -->
        <div class="flex items-center justify-center gap-2 mt-3">
          <% if @user.admin? %>
            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-amber-500 text-white">관리자</span>
          <% end %>
          <% if @user.oauth_user? %>
            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-card/20 text-white">OAuth</span>
          <% end %>
          <% if @user.deleted? %>
            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-red-500 text-white flex items-center gap-1">
              <span class="w-1.5 h-1.5 rounded-full bg-card"></span>
              Withdrawn
            </span>
          <% else %>
            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-green-500 text-white flex items-center gap-1">
              <span class="w-1.5 h-1.5 rounded-full bg-card"></span>
              Active
            </span>
          <% end %>
        </div>
      </div>

      <!-- 프로필 정보 -->
      <div class="p-5 space-y-4">
        <!-- 기본 정보 -->
        <div class="space-y-3">
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">가입일</span>
            <span class="font-medium text-foreground"><%= @user.created_at.strftime("%Y-%m-%d") %></span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">가입 경과</span>
            <span class="font-medium text-foreground"><%= time_ago_in_words(@user.created_at) %></span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">최근 로그인</span>
            <span class="font-medium text-foreground">
              <%= @user.last_sign_in_at&.strftime("%m/%d %H:%M") || "-" %>
            </span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">인증 방식</span>
            <span class="font-medium text-foreground">
              <% if @user.oauth_user? %>
                <%= @user.connected_providers.map(&:capitalize).join(", ") %>
              <% else %>
                이메일
              <% end %>
            </span>
          </div>
        </div>

        <!-- 활동 통계 -->
        <div class="pt-4 border-t border-border">
          <p class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-3">활동 통계</p>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-muted rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-foreground"><%= @posts_count %></p>
              <p class="text-xs text-muted-foreground">게시글</p>
            </div>
            <div class="bg-muted rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-foreground"><%= @comments_count %></p>
              <p class="text-xs text-muted-foreground">댓글</p>
            </div>
            <div class="bg-muted rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-foreground"><%= @messages_count %></p>
              <p class="text-xs text-muted-foreground">메시지</p>
            </div>
            <div class="bg-muted rounded-lg p-3 text-center">
              <p class="text-xl font-bold text-foreground"><%= @chat_rooms.count %></p>
              <p class="text-xs text-muted-foreground">채팅방</p>
            </div>
          </div>
        </div>

        <% if @user.bio.present? %>
          <div class="pt-4 border-t border-border">
            <p class="text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">자기소개</p>
            <p class="text-sm text-foreground"><%= @user.bio %></p>
          </div>
        <% end %>

        <!-- 탈퇴 회원 원본 정보 박스 -->
        <% if @user.deleted? && @user_deletion.present? %>
          <div class="pt-4 border-t border-red-200">
            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
              <h4 class="text-sm font-bold text-red-700 flex items-center gap-2 mb-3">
                <%= icon "lock-closed", variant: :solid, css_class: "w-4 h-4" %>
                탈퇴 전 원본 데이터
              </h4>
              <p class="text-xs text-red-500 mb-4">
                법적 분쟁 및 정산 처리를 위해 암호화되어 보관된 정보입니다.<br>
                열람 기록이 자동으로 남습니다.
              </p>

              <div class="space-y-3 text-sm">
                <div>
                  <span class="block text-xs font-semibold text-red-600 mb-0.5">원본 이메일</span>
                  <span class="text-foreground bg-card px-2 py-1 rounded border border-red-100 inline-block"><%= @user_deletion.email_original %></span>
                </div>
                <div>
                  <span class="block text-xs font-semibold text-red-600 mb-0.5">원본 이름</span>
                  <span class="text-foreground bg-card px-2 py-1 rounded border border-red-100 inline-block"><%= @user_deletion.name_original %></span>
                </div>
                <div>
                  <span class="block text-xs font-semibold text-red-600 mb-0.5">탈퇴 사유</span>
                  <span class="text-foreground"><%= @user_deletion.reason_label %></span>
                </div>
                <% if @user_deletion.reason_detail.present? %>
                  <div>
                    <span class="block text-xs font-semibold text-red-600 mb-0.5">상세 사유</span>
                    <span class="text-foreground text-xs"><%= @user_deletion.reason_detail %></span>
                  </div>
                <% end %>
                <div>
                  <span class="block text-xs font-semibold text-red-600 mb-0.5">탈퇴일</span>
                  <span class="text-foreground"><%= @user.deleted_at.strftime("%Y-%m-%d %H:%M") %></span>
                </div>
                <div>
                  <span class="block text-xs font-semibold text-red-600 mb-0.5">데이터 파기 예정일</span>
                  <span class="text-foreground"><%= @user_deletion.destroy_scheduled_at&.strftime("%Y-%m-%d") || "-" %></span>
                </div>
              </div>

              <!-- 상세 보기 링크 -->
              <%= link_to admin_user_deletion_path(@user_deletion),
                          class: "mt-4 inline-flex items-center text-sm text-red-600 link-hover relative font-medium" do %>
                탈퇴 기록 상세 보기 →
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- 액션 버튼 -->
        <div class="pt-4 border-t border-border space-y-2">
          <button class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-muted text-foreground rounded-lg text-sm font-medium btn-hover">
            <%= icon "envelope", variant: :outline, css_class: "w-4 h-4" %>
            메시지 보내기
          </button>
          <button class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg text-sm font-medium btn-hover"
                  onclick="confirm('정말 이 사용자를 정지하시겠습니까?') && alert('정지 기능은 준비 중입니다.')">
            <%= icon "no-symbol", variant: :outline, css_class: "w-4 h-4" %>
            사용자 정지
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 오른쪽: 탭 콘텐츠 -->
  <div class="flex-1 min-w-0" data-controller="tabs" data-tabs-default-value="chatrooms">
    <!-- 탭 네비게이션 -->
    <div class="bg-card rounded-xl border border-border overflow-hidden">
      <div class="border-b border-border">
        <nav class="flex -mb-px" role="tablist" data-tabs-target="list">
          <button type="button"
                  class="px-6 py-3 text-sm font-medium text-muted-foreground btn-hover [&.is-active]:text-primary [&.is-active]:border-b-2 [&.is-active]:border-primary [&.is-active]:bg-primary/5"
                  data-tabs-target="trigger"
                  data-tab-id="chatrooms"
                  data-action="click->tabs#select"
                  role="tab">
            <%= icon "chat-bubble-left-right", variant: :outline, css_class: "w-4 h-4 inline mr-1.5" %>
            채팅방 (<%= @chat_rooms.count %>)
          </button>
          <button type="button"
                  class="px-6 py-3 text-sm font-medium text-muted-foreground btn-hover [&.is-active]:text-primary [&.is-active]:border-b-2 [&.is-active]:border-primary [&.is-active]:bg-primary/5"
                  data-tabs-target="trigger"
                  data-tab-id="posts"
                  data-action="click->tabs#select"
                  role="tab">
            <%= icon "document-text", variant: :outline, css_class: "w-4 h-4 inline mr-1.5" %>
            게시글 (<%= @posts_count %>)
          </button>
          <button type="button"
                  class="px-6 py-3 text-sm font-medium text-muted-foreground btn-hover [&.is-active]:text-primary [&.is-active]:border-b-2 [&.is-active]:border-primary [&.is-active]:bg-primary/5"
                  data-tabs-target="trigger"
                  data-tab-id="comments"
                  data-action="click->tabs#select"
                  role="tab">
            <%= icon "chat-bubble-bottom-center-text", variant: :outline, css_class: "w-4 h-4 inline mr-1.5" %>
            댓글 (<%= @comments_count %>)
          </button>
        </nav>
      </div>

      <!-- 채팅방 목록 -->
      <div class="p-4" data-tabs-target="panel" data-tab-id="chatrooms" role="tabpanel">
        <% if @chat_rooms.any? %>
          <div class="space-y-3">
            <% @chat_rooms.each do |room| %>
              <div class="border border-border rounded-lg card-hover">
                <div class="p-4">
                  <!-- 채팅방 헤더 -->
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <!-- 상대방 아바타 -->
                      <% other_user = room.users.find { |u| u != @user } || room.users.first %>
                      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white font-medium">
                        <%= other_user&.name&.first&.upcase || "?" %>
                      </div>
                      <div>
                        <p class="font-medium text-foreground">
                          <%= room.users.map(&:name).join(" ↔ ") %>
                        </p>
                        <p class="text-xs text-muted-foreground">
                          채팅방 #<%= room.id %> · <%= room.messages.count %>개 메시지
                        </p>
                      </div>
                    </div>

                    <!-- 열람 버튼 -->
                    <%= link_to admin_chat_room_path(room),
                                class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 rounded-lg btn-hover" do %>
                      <%= icon "eye", variant: :outline, css_class: "w-4 h-4" %>
                      대화 열람
                    <% end %>
                  </div>

                  <!-- 최근 메시지 미리보기 -->
                  <% if room.messages.any? %>
                    <% last_msg = room.messages.last %>
                    <div class="bg-muted rounded-lg p-3">
                      <div class="flex items-start gap-2">
                        <div class="w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-medium text-muted-foreground flex-shrink-0 mt-0.5">
                          <%= last_msg.sender&.name&.first&.upcase || "S" %>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="flex items-center gap-2 mb-0.5">
                            <span class="text-xs font-medium text-foreground">
                              <%= last_msg.sender&.name || "시스템" %>
                            </span>
                            <span class="text-xs text-muted-foreground">
                              <%= last_msg.created_at.strftime("%m/%d %H:%M") %>
                            </span>
                          </div>
                          <p class="text-sm text-muted-foreground truncate"><%= last_msg.content.truncate(80) %></p>
                        </div>
                      </div>
                    </div>
                  <% else %>
                    <div class="bg-muted rounded-lg p-3 text-center">
                      <p class="text-sm text-muted-foreground">대화 내용 없음</p>
                    </div>
                  <% end %>

                  <!-- 메타 정보 -->
                  <div class="flex items-center gap-4 mt-3 text-xs text-muted-foreground">
                    <span>생성: <%= room.created_at.strftime("%Y-%m-%d") %></span>
                    <% if room.last_message_at %>
                      <span>마지막 활동: <%= time_ago_in_words(room.last_message_at) %> 전</span>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="py-12 text-center">
            <%= icon "chat-bubble-left-right", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
            <h3 class="mt-2 text-sm font-medium text-foreground">채팅방 없음</h3>
            <p class="mt-1 text-sm text-muted-foreground">이 사용자는 참여 중인 채팅방이 없습니다.</p>
          </div>
        <% end %>
      </div>

      <!-- 게시글 목록 -->
      <div class="p-4 hidden" data-tabs-target="panel" data-tab-id="posts" role="tabpanel">
        <% if @posts.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-border">
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">제목</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">카테고리</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">반응</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">작성일</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-muted-foreground uppercase tracking-wider">액션</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @posts.each do |post| %>
                  <tr class="card-hover">
                    <td class="px-4 py-3">
                      <%= link_to post.title.truncate(40), post_path(post), class: "text-sm font-medium text-foreground link-hover relative", target: "_blank" %>
                    </td>
                    <td class="px-4 py-3">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        <%= case post.category
                            when 'free' then 'bg-gray-100 text-gray-800'
                            when 'question' then 'bg-blue-100 text-blue-800'
                            when 'promotion' then 'bg-purple-100 text-purple-800'
                            when 'hiring' then 'bg-green-100 text-green-800'
                            when 'seeking' then 'bg-orange-100 text-orange-800'
                            else 'bg-gray-100 text-gray-800'
                            end %>">
                        <%= post.category_label %>
                      </span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-3 text-sm text-muted-foreground">
                        <span class="flex items-center gap-1">
                          <%= icon "heart", variant: :solid, css_class: "w-4 h-4 text-red-400" %>
                          <%= post.likes_count %>
                        </span>
                        <span class="flex items-center gap-1">
                          <%= icon "chat-bubble-left", variant: :solid, css_class: "w-4 h-4 text-blue-400" %>
                          <%= post.comments_count %>
                        </span>
                        <span class="flex items-center gap-1">
                          <%= icon "eye", variant: :solid, css_class: "w-4 h-4 text-gray-400" %>
                          <%= post.views_count %>
                        </span>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">
                      <%= time_ago_in_words(post.created_at) %> 전
                    </td>
                    <td class="px-4 py-3 text-right">
                      <%= button_to destroy_post_admin_user_path(@user, post_id: post.id),
                          method: :delete,
                          form: { data: { turbo_confirm: "정말 이 게시글을 삭제하시겠습니까?\n\n제목: #{post.title}\n\n이 작업은 되돌릴 수 없으며, 관련 댓글도 함께 삭제됩니다." } },
                          class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 rounded-lg btn-hover" do %>
                        <%= icon "trash", variant: :outline, css_class: "w-4 h-4" %>
                        삭제
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <!-- 페이지네이션 -->
          <% if @posts.total_pages > 1 %>
            <div class="mt-4 flex justify-center">
              <%= paginate @posts, param_name: :posts_page %>
            </div>
          <% end %>
        <% else %>
          <div class="py-12 text-center">
            <%= icon "document-text", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
            <h3 class="mt-2 text-sm font-medium text-foreground">게시글 없음</h3>
            <p class="mt-1 text-sm text-muted-foreground">이 사용자는 작성한 게시글이 없습니다.</p>
          </div>
        <% end %>
      </div>

      <!-- 댓글 목록 -->
      <div class="p-4 hidden" data-tabs-target="panel" data-tab-id="comments" role="tabpanel">
        <% if @comments.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-border">
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">내용</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">게시글</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">반응</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold text-muted-foreground uppercase tracking-wider">작성일</th>
                  <th class="px-4 py-3 text-right text-xs font-semibold text-muted-foreground uppercase tracking-wider">액션</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @comments.each do |comment| %>
                  <tr class="card-hover">
                    <td class="px-4 py-3 max-w-xs">
                      <p class="text-sm text-foreground truncate" title="<%= comment.content %>">
                        <% if comment.reply? %>
                          <span class="text-muted-foreground">↳ </span>
                        <% end %>
                        <%= comment.content.truncate(60) %>
                      </p>
                    </td>
                    <td class="px-4 py-3">
                      <% if comment.post %>
                        <%= link_to comment.post.title.truncate(30), post_path(comment.post), class: "text-sm text-muted-foreground link-hover relative", target: "_blank" %>
                      <% else %>
                        <span class="text-sm text-muted-foreground italic">삭제된 게시글</span>
                      <% end %>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex items-center gap-3 text-sm text-muted-foreground">
                        <span class="flex items-center gap-1">
                          <%= icon "heart", variant: :solid, css_class: "w-4 h-4 text-red-400" %>
                          <%= comment.likes_count %>
                        </span>
                        <% if comment.root? && comment.replies_count > 0 %>
                          <span class="flex items-center gap-1">
                            <%= icon "chat-bubble-left", variant: :solid, css_class: "w-4 h-4 text-blue-400" %>
                            <%= comment.replies_count %>
                          </span>
                        <% end %>
                      </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">
                      <%= time_ago_in_words(comment.created_at) %> 전
                    </td>
                    <td class="px-4 py-3 text-right">
                      <%= button_to destroy_comment_admin_user_path(@user, comment_id: comment.id),
                          method: :delete,
                          form: { data: { turbo_confirm: "정말 이 댓글을 삭제하시겠습니까?\n\n내용: #{comment.content.truncate(50)}\n\n이 작업은 되돌릴 수 없습니다." } },
                          class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-red-600 bg-red-50 rounded-lg btn-hover" do %>
                        <%= icon "trash", variant: :outline, css_class: "w-4 h-4" %>
                        삭제
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <!-- 페이지네이션 -->
          <% if @comments.total_pages > 1 %>
            <div class="mt-4 flex justify-center">
              <%= paginate @comments, param_name: :comments_page %>
            </div>
          <% end %>
        <% else %>
          <div class="py-12 text-center">
            <%= icon "chat-bubble-bottom-center-text", variant: :outline, css_class: "mx-auto h-12 w-12 text-muted-foreground/50" %>
            <h3 class="mt-2 text-sm font-medium text-foreground">댓글 없음</h3>
            <p class="mt-1 text-sm text-muted-foreground">이 사용자는 작성한 댓글이 없습니다.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
