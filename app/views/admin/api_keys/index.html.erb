<% content_for :page_title, "API 키 관리" %>

<!-- 브레드크럼 -->
<nav class="flex items-center gap-2 text-sm text-muted-foreground mb-6">
  <%= icon "home", variant: :solid, css_class: "w-4 h-4" %>
  <span>/</span>
  <span class="text-foreground font-medium">API 키 관리</span>
</nav>

<!-- 발급된 토큰 알림 (1회성) -->
<% if flash[:api_token].present? %>
  <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
    <div class="flex items-start gap-3">
      <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center flex-shrink-0">
        <%= icon "check-circle", variant: :solid, css_class: "w-5 h-5 text-green-600" %>
      </div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-medium text-green-800 mb-2">API 키가 발급되었습니다</p>
        <div class="bg-white border border-green-300 rounded-lg p-3">
          <p class="text-xs text-green-700 mb-1">이 토큰은 한 번만 표시됩니다. 안전한 곳에 복사해두세요:</p>
          <code class="block text-sm font-mono text-green-900 break-all select-all"><%= flash[:api_token] %></code>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- 상단 통계 -->
<div class="grid grid-cols-3 gap-4 mb-6">
  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
        <%= icon "key", variant: :solid, css_class: "w-5 h-5 text-primary" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @users_with_tokens.count %></p>
        <p class="text-xs text-muted-foreground">발급된 키</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
        <%= icon "users", variant: :solid, css_class: "w-5 h-5 text-amber-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground"><%= @users_for_assignment.count %></p>
        <p class="text-xs text-muted-foreground">발급 가능</p>
      </div>
    </div>
  </div>

  <div class="bg-card rounded-xl border border-border p-4 card-hover">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center">
        <%= icon "globe-alt", variant: :solid, css_class: "w-5 h-5 text-green-600" %>
      </div>
      <div>
        <p class="text-2xl font-bold text-foreground">POST</p>
        <p class="text-xs text-muted-foreground">/api/v1/posts</p>
      </div>
    </div>
  </div>
</div>

<!-- API 키 발급 -->
<div class="bg-card rounded-xl border border-border p-6 mb-6">
  <h2 class="text-lg font-semibold text-foreground mb-4">새 API 키 발급</h2>

  <%= form_with url: admin_api_keys_path, method: :post, class: "flex items-end gap-4" do |f| %>
    <div class="flex-1">
      <label for="user_id" class="block text-sm font-medium text-muted-foreground mb-2">사용자 선택</label>
      <select name="user_id" id="user_id" required
              class="w-full px-4 py-2 border border-border rounded-lg bg-background text-foreground focus:ring-2 focus:ring-primary focus:border-primary">
        <option value="">-- 사용자를 선택하세요 --</option>
        <% @users_for_assignment.each do |user| %>
          <option value="<%= user.id %>">
            <%= user.name %> (<%= user.email %>)
          </option>
        <% end %>
      </select>
    </div>

    <button type="submit"
            class="px-6 py-2 bg-primary hover:bg-primary/90 text-primary-foreground font-medium rounded-lg transition-colors">
      <%= icon "plus", variant: :solid, css_class: "w-4 h-4 inline mr-1" %>
      API 키 발급
    </button>
  <% end %>
</div>

<!-- 발급된 키 목록 -->
<div class="bg-card rounded-xl border border-border overflow-hidden">
  <div class="px-6 py-4 border-b border-border">
    <h2 class="text-lg font-semibold text-foreground">발급된 API 키</h2>
  </div>

  <% if @users_with_tokens.any? %>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-muted/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">사용자</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">이메일</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">토큰 (마스킹)</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">발급일</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">액션</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <% @users_with_tokens.each do |user| %>
            <tr class="hover:bg-muted/30 transition-colors">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center">
                    <span class="text-sm font-medium text-primary"><%= user.name.first.upcase %></span>
                  </div>
                  <span class="text-sm font-medium text-foreground"><%= user.name %></span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                <%= user.email %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <code class="text-xs font-mono bg-muted px-2 py-1 rounded">
                  <%= user.api_token.first(6) %>...<%= user.api_token.last(6) %>
                </code>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                <%= user.updated_at.strftime("%Y-%m-%d %H:%M") %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <%= button_to admin_api_key_path(user),
                              method: :delete,
                              data: { turbo_confirm: "#{user.name}의 API 키를 폐기하시겠습니까?\n이 작업은 되돌릴 수 없습니다." },
                              class: "px-3 py-1 text-sm text-destructive hover:bg-destructive/10 rounded-lg transition-colors" do %>
                  <%= icon "trash", variant: :outline, css_class: "w-4 h-4 inline mr-1" %>
                  폐기
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="px-6 py-12 text-center">
      <div class="w-12 h-12 rounded-full bg-muted mx-auto mb-4 flex items-center justify-center">
        <%= icon "key", variant: :outline, css_class: "w-6 h-6 text-muted-foreground" %>
      </div>
      <p class="text-muted-foreground">발급된 API 키가 없습니다.</p>
      <p class="text-sm text-muted-foreground mt-1">위에서 사용자를 선택하여 API 키를 발급하세요.</p>
    </div>
  <% end %>
</div>

<!-- API 사용 안내 -->
<div class="mt-6 bg-muted/30 rounded-xl border border-border p-6">
  <h3 class="text-sm font-semibold text-foreground mb-3">API 사용 방법</h3>
  <div class="bg-background rounded-lg p-4 font-mono text-xs text-muted-foreground overflow-x-auto">
    <pre>curl -X POST https://undrewai.com/api/v1/posts \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "post": {
      "title": "게시글 제목",
      "content": "게시글 내용",
      "category": "free"
    }
  }'</pre>
  </div>
  <p class="text-xs text-muted-foreground mt-3">
    카테고리: <code class="bg-muted px-1 rounded">free</code> (자유),
    <code class="bg-muted px-1 rounded">question</code> (질문),
    <code class="bg-muted px-1 rounded">promotion</code> (홍보)
  </p>
</div>
