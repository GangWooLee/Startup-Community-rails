name: CI

on:
  pull_request:
  push:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== Security Scans (Î≥ëÎ†¨ Ïã§Ìñâ) =====
  scan_ruby:
    name: üîí Security Scan (Ruby)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan for Rails security vulnerabilities
        # --no-exit-on-error: ÌååÏã± ÏóêÎü¨(exit 7)Î°ú Ïù∏Ìïú CI Ïã§Ìå® Î∞©ÏßÄ
        # Ïã§Ï†ú Î≥¥Ïïà Í≤ΩÍ≥†(exit 3)Îäî Ïó¨Ï†ÑÌûà Ïã§Ìå®Ìï®
        run: bin/brakeman --no-pager --no-exit-on-error

      - name: Scan for vulnerable gems
        run: bin/bundler-audit check --update

  scan_js:
    name: üîí Security Scan (JS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan JS dependencies
        run: bin/importmap audit

  # ===== Code Quality =====
  lint:
    name: üé® Lint (Rubocop)
    runs-on: ubuntu-latest
    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare RuboCop cache
        uses: actions/cache@v4
        env:
          DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
        with:
          path: ${{ env.RUBOCOP_CACHE_ROOT }}
          key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
          restore-keys: |
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-

      - name: Lint code for consistent style
        run: bin/rubocop -f github

  # ===== Tests =====
  test:
    name: üß™ Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [ lint ]
    env:
      RAILS_ENV: test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      GEMINI_API_KEY: "test_dummy_key"
      RESEND_API_KEY: "test_dummy_key"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare database
        run: bin/rails db:test:prepare

      - name: Run tests
        run: bin/rails test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          if-no-files-found: ignore

  system-test:
    name: üñ•Ô∏è System Tests
    runs-on: ubuntu-latest
    needs: [ test ]
    env:
      RAILS_ENV: test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      GEMINI_API_KEY: "test_dummy_key"
      RESEND_API_KEY: "test_dummy_key"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Prepare database
        run: bin/rails db:test:prepare

      - name: Run System Tests
        run: bin/rails test:system

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots
          path: ${{ github.workspace }}/tmp/screenshots
          if-no-files-found: ignore

  # ===== CI Success Gate =====
  ci-success:
    name: ‚úÖ CI Success
    runs-on: ubuntu-latest
    needs: [ scan_ruby, scan_js, lint, test, system-test ]
    if: always()
    env:
      SCAN_RUBY_RESULT: ${{ needs.scan_ruby.result }}
      SCAN_JS_RESULT: ${{ needs.scan_js.result }}
      LINT_RESULT: ${{ needs.lint.result }}
      TEST_RESULT: ${{ needs.test.result }}
      SYSTEM_TEST_RESULT: ${{ needs.system-test.result }}
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "$SCAN_RUBY_RESULT" != "success" ]] || \
             [[ "$SCAN_JS_RESULT" != "success" ]] || \
             [[ "$LINT_RESULT" != "success" ]] || \
             [[ "$TEST_RESULT" != "success" ]] || \
             [[ "$SYSTEM_TEST_RESULT" != "success" ]]; then
            echo "‚ùå One or more jobs failed"
            exit 1
          fi
          echo "‚úÖ All CI jobs passed!"
