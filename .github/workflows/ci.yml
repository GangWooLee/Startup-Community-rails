name: CI

on:
  pull_request:
  push:
    branches: [ main ]

# Cancel in-progress runs for the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== Security Scans (ë³‘ë ¬ ì‹¤í–‰) =====
  scan_ruby:
    name: ğŸ”’ Security Scan (Ruby)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan for Rails security vulnerabilities
        # config/brakeman.ymlì—ì„œ ì œì™¸ íŒŒì¼ ëª…ì‹œ
        run: bin/brakeman --no-pager

      - name: Scan for vulnerable gems
        run: bin/bundler-audit check --update

  scan_js:
    name: ğŸ”’ Security Scan (JS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Scan JS dependencies
        run: bin/importmap audit

  # ===== Code Quality =====
  lint:
    name: ğŸ¨ Lint (Rubocop)
    runs-on: ubuntu-latest
    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare RuboCop cache
        uses: actions/cache@v4
        env:
          DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
        with:
          path: ${{ env.RUBOCOP_CACHE_ROOT }}
          key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
          restore-keys: |
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-

      - name: Lint code for consistent style
        run: bin/rubocop -f github

  # ===== Tests =====
  test:
    name: ğŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [ lint ]
    env:
      RAILS_ENV: test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      GEMINI_API_KEY: "test_dummy_key"
      RESEND_API_KEY: "test_dummy_key"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Prepare database
        run: bin/rails db:test:prepare

      - name: Run tests
        run: bin/rails test

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          if-no-files-found: ignore

  system-test:
    name: ğŸ–¥ï¸ System Tests
    runs-on: ubuntu-latest
    needs: [ test ]
    # 2026-01-08: í…ŒìŠ¤íŠ¸ í—¬í¼ í†µí•© ì™„ë£Œë¡œ continue-on-error ì œê±°
    # ì´ì œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ë„ í•„ìˆ˜ í†µê³¼ ì¡°ê±´
    env:
      RAILS_ENV: test
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      GEMINI_API_KEY: "test_dummy_key"
      RESEND_API_KEY: "test_dummy_key"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install libvips (for image processing)
        run: sudo apt-get update && sudo apt-get install -y libvips

      - name: Prepare database
        run: bin/rails db:test:prepare

      - name: Run System Tests
        run: bin/rails test:system

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots
          path: ${{ github.workspace }}/tmp/screenshots
          if-no-files-found: ignore

  # ===== Playwright E2E Tests =====
  # NOTE: E2E í…ŒìŠ¤íŠ¸ëŠ” CIì—ì„œ ì œê±°ë¨ (2026-01-12)
  # - CI í™˜ê²½ì—ì„œ ë¶ˆì•ˆì •í•˜ê³  ë””ë²„ê¹…ì´ ì–´ë ¤ì›€
  # - ë¡œì»¬ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰: npx playwright test
  # - ì¤‘ìš”í•œ ë³€ê²½ í›„ ë°˜ë“œì‹œ ë¡œì»¬ E2E í…ŒìŠ¤íŠ¸ í•„ìˆ˜!

  # ===== CI Success Gate =====
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [ scan_ruby, scan_js, lint, test, system-test ]
    if: always()
    env:
      SCAN_RUBY_RESULT: ${{ needs.scan_ruby.result }}
      SCAN_JS_RESULT: ${{ needs.scan_js.result }}
      LINT_RESULT: ${{ needs.lint.result }}
      TEST_RESULT: ${{ needs.test.result }}
      SYSTEM_TEST_RESULT: ${{ needs.system-test.result }}
    steps:
      - name: Check required jobs passed
        run: |
          echo "ğŸ“Š Job Results:"
          echo "  - Security Scan (Ruby): $SCAN_RUBY_RESULT"
          echo "  - Security Scan (JS): $SCAN_JS_RESULT"
          echo "  - Lint: $LINT_RESULT"
          echo "  - Unit Tests: $TEST_RESULT"
          echo "  - System Tests: $SYSTEM_TEST_RESULT"
          echo ""
          echo "â„¹ï¸ E2E Tests: ë¡œì»¬ì—ì„œ ìˆ˜ë™ ì‹¤í–‰ í•„ìš” (npx playwright test)"
          echo ""

          # Required jobs check
          if [[ "$SCAN_RUBY_RESULT" != "success" ]] || \
             [[ "$SCAN_JS_RESULT" != "success" ]] || \
             [[ "$LINT_RESULT" != "success" ]] || \
             [[ "$TEST_RESULT" != "success" ]] || \
             [[ "$SYSTEM_TEST_RESULT" != "success" ]]; then
            echo "âŒ One or more required jobs failed"
            exit 1
          fi

          echo "âœ… All required CI jobs passed!"
